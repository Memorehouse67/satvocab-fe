"use strict";var MSSlideshowModule,CBSlideshowModule=(!function(n){n.instances={},n.setupDiv=function(e,t,a,i){return n.cleanupDiv(e),n.instances[e]=new MSSlideshowModule(e,t,a,i),n.instances[e]},n.cleanupDiv=function(e){var t=n.instances[e];t&&(t.cleanup(),delete n.instances[e])},window.AudioContext=window.AudioContext||window.webkitAudioContext}(MSSlideshowModule=MSSlideshowModule||{}),MSSlideshowModule),MSSlideshowModuleScript=document.currentScript,MSSlideshowModuleSrc=MSSlideshowModuleScript.getAttribute("src");function MSSlideshowModule(divid,userid,moduleid,params){var that=this,extRoot=MSSlideshowModuleSrc.replace("slideshow.js",""),serverBase=(params=params||{},params.standalone?null:"localhost"==window.location.hostname?"http://localhost:3000/":"https://api.mediasemantics.com/"),mediaBase=params.standalone?null:"localhost"!=window.location.hostname||params.videoData&&"edit"!=params.version?"https://media.mediasemantics.com/":"http://"+window.location.host+"/cbmedia/",moduletype,data,version,hash,slideShowing,stepShowing,slidePlaying,stepPlaying,answerChosen,reactionUsed,eventUsed,eventObj,eventProp,playing=!1,playEnding,playOnPlayEnded,scenePreviewMode,slidePreviewMode,visualsPreviewMode,eventPreviewMode,workMode,stepPreview,scriptObj,scriptProp,line,cxSlide,cySlide,highlight,alt,roles,fade=!0,playQueue=[],playCur=null,deferredEvent=null,idleType="normal",enduserid,startupPaused=!1,variables={},extensions=[],storing,storePending,firstPlayOccurred,nav,elapsedSinceLastVisit,slideShowingInitial,stepShowingInitial,token,apogee,reentrantGuard,loadSlideResourcesCallback;function resetOuterVars(){playOnPlayEnded=playEnding=playing=!1,fade=!(highlight=null),playQueue=[],deferredEvent=playCur=null,idleType="normal",enduserid="",nav=firstPlayOccurred=storePending=storing=!(variables={}),stepShowingInitial=slideShowingInitial=eventUsed=eventUsed=reactionUsed=answerChosen=void 0,resetChatbotVars()}function loadData(){token=params.token;var t=new XMLHttpRequest;t.onload=function(){data=null;try{var e=JSON.parse(t.response);if(serverBase){if(!e.success)throw error();moduletype=e.type,data=e.data,version=e.data.version}else moduletype=(data=e).type,version=data.version}catch(e){console.log("People Builder "+(serverBase?"service error":"missing cb/"+moduleid+"/data.json"))}data&&loadRequires(0)},t.open("GET",serverBase?serverBase+"cb/getmoduledata?userid="+userid+"&moduleid="+moduleid+("edit"==params.version?"&version=edit":"")+(token?"&token="+token:""):"cb/"+moduleid+"/data.json",!0),t.send()}function loadRequires(e){var t,a;return e==(data.requires||[]).length?onDataLoaded():window["MSExt"+data.requires[e]]?finishLoadRequires(e):(t=extRoot+"extensions/"+data.requires[e]+".js",(a=document.createElement("script")).onload=function(){finishLoadRequires(e)},a.onerror=function(){console.log("missing "+t)},a.src=t,void document.head.appendChild(a))}function finishLoadRequires(e){extensions.push(window["MSExt"+data.requires[e]].initExtension(divid,userid,moduleid,params,that,data)),loadRequires(e+1)}function onDataLoaded(){if(cxSlide=data.scene.slideWidth||400,cySlide=data.scene.slideHeight||300,alt=data.scene.altCharacter&&!data.scene.suppressAlt,roles=alt?{main:!0,alt:!0}:{main:!0},"edit"==params.version&&(version="edit"),params.slidePreview||params.visualsPreview){for(var e=0;e<data.slides.length;e++)data.slides[e].id!=params.slidePreview&&data.slides[e].id!=params.visualsPreview&&(data.slides.splice(e,1),e--);params.visualsPreview?visualsPreviewMode=!0:slidePreviewMode=!0,workMode=params.workMode,stepPreview=params.stepPreview}params.scenePreview&&("explainer"!=moduletype&&"scenario"!=moduletype||(data.slides=[]),scenePreviewMode=!0),params.eventPreview&&(eventPreviewMode=!0),(params.slide||params.round)&&(slideShowingInitial=Math.max(1,Math.min(that.slides(),params.slide||params.round))),params.step&&(stepShowingInitial=Math.max(1,Math.min(that.slides(),params.step))),playing="boolean"==typeof params.playing?params.playing:!!data.autoplay,data.scene.playShield&&("always"==data.scene.playShieldBehavior||"needed"==(data.scene.playShieldBehavior||"needed")&&audioContext&&"suspended"==audioContext.state)&&(playing=!1),(slidePreviewMode||eventPreviewMode)&&(playing=!1),"boolean"==typeof params.preload&&(preload=params.preload),"boolean"==typeof params.fade&&(fade=params.fade),"string"==typeof params.idleType&&(idleType=params.idleType),"boolean"==typeof params.preloadOnly&&(preloadOnly=params.preloadOnly),0==data.slides.length&&(data.slides=[{type:""}],slideShowing=1),data.style=data.style||{},updateStylesheet(),setupIdentity(),data.scene.chatArea||scenePreviewMode?loadSlideshowStyle(loadHash):loadHash()}function setupIdentity(){if(params.enduserid)"Preview"==(enduserid=params.enduserid)&&sessionStorage.clear();else{if(params.identity&&(data.identity=params.identity),data.identity,deleteCookie("enduserid"),"device"==data.identity&&(enduserid=getCookie("enduserid")),sessionStorage[moduleid+"-enduserid"]&&(enduserid=sessionStorage[moduleid+"-enduserid"],nav=!0),!enduserid){enduserid=(new Date).getTime().toString();for(var e=0;e<=3;e++)enduserid+=Math.floor(10*Math.random())}"device"==data.identity&&setCookie("enduserid",enduserid,365),sessionStorage.setItem(moduleid+"-enduserid",enduserid)}}function loadSlideshowStyle(e){var t=document.getElementsByTagName("head")[0],a=document.createElement("link");a.href=mediaBase+"slideshow/slideshow-1.0.0.css",a.type="text/css",a.rel="stylesheet",a.onload=function(){e()},t.appendChild(a)}function loadHash(){var t=new XMLHttpRequest;t.onload=function(){hash=null;try{var e=JSON.parse(t.response);if(serverBase){if(!e.success)throw error();hash=e.hash}else hash=e}catch(e){console.log("People Builder "+(serverBase?"service error":"missing cb/"+moduleid+"/hash.json"))}hash&&onHashLoaded()},t.open("GET",serverBase?serverBase+"cb/getmodulehash?userid="+userid+"&moduleid="+moduleid:"cb/"+moduleid+"/hash.json",!0),t.send()}function onHashLoaded(){if(preloadOnly)return document.getElementById(divid).dispatchEvent(createEvent("moduleLoaded"));loadVariables(function(){loadNavBarResources(function(){loadBackgroundResources(function(){loadCharacterBackgroundResources("main",function(){loadCharacterBackgroundResources("alt",function(){loadSlideBackgroundResources(function(){loadForegroundResources(function(){loadSlideResources(function(){loadVideoResources(onResourcesLoaded)})})})})})})})})}function onResourcesLoaded(){document.getElementById(divid)&&(setupScene(),setupBackground(),visualsPreviewMode||(clientScale("main")&&setupClientScaleBackground("main"),alt&&clientScale("alt")&&setupClientScaleBackground("alt"),setupShadow("main"),alt&&setupShadow("alt"),setupCharacters(),setupForeground(),(data.scene.playShield||scenePreviewMode)&&(setupPlayShield(data.width,data.height),showPlayShield(!1),data.scene.playShield&&("always"==data.scene.playShieldBehavior||"needed"==(data.scene.playShieldBehavior||"needed")&&data.autoplay&&audioContext&&"suspended"==audioContext.state)&&showPlayShield(!0))),"explainer"!=moduletype&&"scenario"!=moduletype&&(setupSlideBackground(),setupSlides(),bindSlides(),updateSlideVisuals(),visualsPreviewMode||setupSlideShadow()),scenePreviewMode&&updateHighlight(),visualsPreviewMode||setupNavBar(),!data.scene.chatArea||scenePreviewMode||visualsPreviewMode||setupChatArea(),visualsPreviewMode&&charactersLoaded(),!data.leftoff||scenePreviewMode||visualsPreviewMode||(variables.LastSlide&&(slideShowingInitial=Math.max(1,Math.min(that.slides(),parseInt(variables.LastSlide)))),variables.LastStep&&(stepShowingInitial=Math.max(1,Math.min(that.steps(),parseInt(variables.LastStep))))))}function setupScene(){var e=data.scene,t=document.getElementById(divid),a="",i=data.width,n=data.height,d=(visualsPreviewMode&&(i=cxSlide,n=cySlide),0),s=0;if(visualsPreviewMode&&(d=-e.slideLeft||0,s=-e.slideTop||0),a=a+('<div id="'+divid+'-top" style="visibility:hidden; width:'+i+"px; height:"+n+'px; position:relative; overflow:hidden">')+('  <div id="'+divid+'-background-div" style="position:absolute; top:'+d+"px; left:"+s+"px; width:"+data.width+"px; height:"+data.height+'px;"></div>'),"explainer"==moduletype?a+='  <img src="'+urlFromVideo(data.scene.video)+'" id="'+divid+'-video" style="user-select:none; pointer-events:none; position:absolute; top:'+e.videoTop+"px; left:"+e.videoLeft+"px; width:"+e.videoWidth+"px; height:"+e.videoHeight+'px;">':(d=e.slideLeft||0,s=e.slideTop||0,visualsPreviewMode&&(s=d=0),a=(a=a+'  <div id="'+divid+'-slide-background-div" style="position:absolute; top:'+s+"px; left:"+d+"px; width:"+cxSlide+"px; height:"+cySlide+'px;"></div>  <div id="'+divid+'-slide-area"           style="position:absolute; top:'+s+"px; left:"+d+"px; width:"+cxSlide+"px; height:"+cySlide+'px; overflow:hidden">')+'    <div id="'+divid+'-slide-holder"       style="position:relative; width:'+cxSlide+"px; height:"+cySlide+'px;"></div>  </div>'),!visualsPreviewMode)for(var o in roles){var r,l,d=e[o+"X"]||0,s=e[o+"Y"]||0,c=e[o+"Width"],u=e[o+"Height"],p=c,h=u,m=c,g=u,v=0,y=0;clientScale(o)&&(r=data.scene[o+"CharacterNaturalWidth"]||750,l=data.scene[o+"CharacterNaturalHeight"]||600,p=r*(e[o+"CharacterDensity"]||1)*(isVector(o)?2:1),h=l*(e[o+"CharacterDensity"]||1)*(isVector(o)?2:1),m=Math.round(r*(e[o+"CharacterScale"]||100)/100),g=Math.round(l*(e[o+"CharacterScale"]||100)/100),v=data.scene[o+"XOffset"]||0,y=data.scene[o+"YOffset"]||0),a=(a=(a=a+('  <div id="'+divid+"-"+o+'-clip-div" style="position:absolute; top:'+s+"px; left:"+d+"px; width:"+c+"px; height:"+u+'px; overflow:hidden; pointer-events:none;">')+'    <div style="position:relative">')+('      <div id="'+divid+"-"+o+'-background-div" style="position:absolute; width:'+c+"px; height:"+u+'px;"></div>')+('      <canvas id="'+divid+"-"+o+'-canvas" width="'+p+'" height="'+h+'" style="position:absolute; top:'+y+"px; left:"+v+"px; width:"+m+"px; height:"+g+'px; pointer-events:none;"></canvas>'))+"    </div>"+"  </div>"}visualsPreviewMode||(a+='  <div id="'+divid+'-foreground-div" style="position:absolute; top:0px; left:0px; width:'+data.width+"px; height:"+data.height+'px;"></div>'),visualsPreviewMode||(a+=renderNavBar(e.navbar),(data.scene.playShield||scenePreviewMode)&&(a+='  <canvas id="'+divid+'-playshield-canvas" style="position:absolute; left:0px; top:0px;" width="'+i+'px" height="'+n+'px"/></canvas>'),audioContext||(a+='  <audio id="'+divid+'-audio"></audio>')),visualsPreviewMode||(a=(a+=renderPromptArea())+renderChatArea()),(scenePreviewMode||visualsPreviewMode)&&(a=(a+='  <div id="'+divid+'-highlight-div" style="border: 2px dashed #00ff00; position:absolute; cursor:move; visibility:hidden"></div>')+'  <div id="'+divid+'-highlight-div-x-resize" style="position:absolute; cursor:ew-resize; visibility:hidden"></div>  <div id="'+divid+'-highlight-div-y-resize" style="position:absolute; cursor:ns-resize; visibility:hidden"></div>'),t.innerHTML=a+="</div>"}function setupClientScaleBackground(e){var t,a=data.scene,i=document.getElementById(divid+"-"+e+"-background-div");i&&(i.style.width=a[e+"Width"]+"px",i.style.height=a[e+"Height"]+"px","solid"==(t=a[e+"BackgroundType"]||"solid")?i.style.background=a[e+"BackgroundSolid"]||"#ffffff":"gradient"==t?i.style.background="linear-gradient("+(a[e+"BackgroundGradient1"]||"#ffffff")+", "+(a[e+"BackgroundGradient2"]||"#ffffff")+")":"image"==t?(a=urlFromImage(a[e+"BackgroundImage"]||""),i.style.backgroundImage=a?'url("'+a+'")':"",i.style.backgroundRepeat="no-repeat",i.style.overflow="hidden",i.style.backgroundSize="cover",i.style.backgroundPosition="center"):"transparent"==t&&(i.style.background="",i.style.backgroundImage=""))}function urlFromImage(e){return e&&"stock:"==e.substr(0,6)?(mediaBase?mediaBase+"stock/image/":"cb/"+moduleid+"/")+e.replace("stock:",""):e&&"file:"==e.substr(0,5)?(mediaBase?mediaBase+userid+"/image/":"cb/"+moduleid+"/")+e.replace("file:",""):null}function urlFromPowerpoint(e,t){return e&&"stock:"==e.substr(0,6)?(mediaBase?mediaBase+"stock/powerpoint/":"cb/"+moduleid+"/")+e.replace("stock:","").replace(".pptx","")+"-"+t+".jpeg":e&&"file:"==e.substr(0,5)?(mediaBase?mediaBase+userid+"/powerpoint/":"cb/"+moduleid+"/")+e.replace("file:","").replace(".pptx","")+"-"+t+".jpeg":null}function setupSlideBackground(){var e=data.scene,t=document.getElementById(divid+"-slide-background-div"),a=e.slideBackgroundType||"solid";"solid"==a?t.style.background=e.slideBackgroundSolid||"#ffffff":"gradient"==a?t.style.background="linear-gradient("+(e.slideBackgroundGradient1||"#ffffff")+", "+(e.slideBackgroundGradient2||"#ffffff")+")":"image"==a?(e=urlFromImage(e.slideBackgroundImage||""),t.style.backgroundImage=e?'url("'+e+'")':"",t.style.backgroundRepeat="no-repeat",t.style.overflow="hidden",t.style.backgroundSize="cover",t.style.backgroundPosition="center"):"transparent"==a&&(t.style.background="",t.style.backgroundImage="")}function setupSlideShadow(){var e=data.scene;document.getElementById(divid+"-slide-background-div").style.boxShadow=e.slideShadow?"0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19)":"none"}function liveAdjustCharacterPositionAndSize(e){var t=document.getElementById(divid+"-"+e+"-clip-div"),a=parseInt(data.scene[e+"X"]||0),i=parseInt(data.scene[e+"Y"]||0),a=(t.style.left=a+"px",t.style.top=i+"px",parseInt(data.scene[e+"Width"]||0)),i=parseInt(data.scene[e+"Height"]||0);t.style.width=a+"px",t.style.height=i+"px"}function liveAdjustCharacterScale(e){var t=data.scene[e+"CharacterNaturalWidth"]||750,a=data.scene[e+"CharacterNaturalHeight"]||600,t=Math.round(t*(data.scene[e+"CharacterScale"]||100)/100),a=Math.round(a*(data.scene[e+"CharacterScale"]||100)/100),e=document.getElementById(divid+"-"+e+"-canvas");e.style.width=t+"px",e.style.height=a+"px"}function liveAdjustCharacterOffset(e){var t=data.scene,a=document.getElementById(divid+"-"+e+"-canvas"),i=parseInt(t[e+"XOffset"]||0),t=parseInt(t[e+"YOffset"]||0);a.style.left=i+"px",a.style.top=t+"px"}function liveAdjustPlayShield(){showPlayShield(data.scene.playShield&&"misc"==highlight)}function showPlayShield(e){var t=document.getElementById(divid+"-playshield-canvas");t&&(t.style.display=e?"block":"none")}function setupShadow(e){var t=data.scene;document.getElementById(divid+"-"+e+"-clip-div").style.boxShadow=t[e+"Shadow"]?"0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19)":"none"}function setupBackground(){var e=data.scene,t=document.getElementById(divid+"-background-div"),a=e.backgroundType||"solid";"solid"==a?t.style.background=e.backgroundSolid||"#ffffff":"gradient"==a?t.style.background="linear-gradient("+(e.backgroundGradient1||"#ffffff")+", "+(e.backgroundGradient2||"#ffffff")+")":"image"==a&&(a=urlFromImage(e.backgroundImage),t.style.backgroundImage=a?'url("'+a+'")':"",t.style.backgroundRepeat="no-repeat",t.style.overflow="hidden",t.style.backgroundSize="cover",t.style.backgroundPosition="center")}function setupForeground(){var e=data.scene,t=document.getElementById(divid+"-foreground-div"),e=urlFromImage(e.foregroundImage||"");t.style.backgroundImage=e?'url("'+e+'")':"",t.style.backgroundRepeat="no-repeat",t.style.overflow="hidden",t.style.backgroundSize="cover",t.style.backgroundPosition="center",t.style.pointerEvents="none"}function slideIndexFromId(e){for(var t=0;t<data.slides.length;t++)if(data.slides[t].id==e)return t;return-1}function slideIdFromIdOrName(e){if(-1==slideIndexFromId(e))for(var t=0;t<data.slides.length;t++)if(data.slides[t].name.toLowerCase()==e.toLowerCase())return data.slides[t].id}function setupCharacters(){execute("main",scenePreviewMode?"&preview=true":"",null,null,null,null)}function characterLoaded(e){"main"==e&&alt?execute("alt",scenePreviewMode?"&preview=true":"",null,null,null,null):charactersLoaded()}function charactersLoaded(){slideShowingInitial?(setSlide(slideShowingInitial,!1),setStep(stepShowingInitial,!1)):setSlide(1,!1),document.getElementById(divid).dispatchEvent(createEvent("moduleLoaded")),startupPaused||fadeInScene()}function fadeInScene(){var e=document.getElementById(divid+"-top");e&&(e.style.visibility="visible",fade?fadeIn(e,400,sceneFullyFadedIn):sceneFullyFadedIn())}function sceneFullyFadedIn(){startIdle(),!playing||scenePreviewMode||slidePreviewMode||visualsPreviewMode||(firstPlayOccurred=!0,playGreeting()||playScript())}function playGreeting(){var e;return nav?e="nav":(e=variables.LastVisit?(elapsedSinceLastVisit=(new Date).getTime()-new Date(variables.LastVisit).getTime(),"return"):"new",setVariable("LastVisit",(new Date).toISOString())),e&&reactToEvent(e)}function setSlide(e,t){var a;(e=Math.max(1,Math.min(that.slides(),e)))==slideShowing&&1==stepShowing||(t&&that.stop(),a=slideShowing,slideShowing=e,stepShowing=1,!reentrantGuard&&a&&(reentrantGuard=!0,document.getElementById(divid).dispatchEvent(createEvent("slideChanged")),reentrantGuard=void 0),data.leftoff&&(variables.LastSlide=that.slide(),variables.LastStep=that.step(),storeVariables()),updateSlideVisuals(!t&&!visualsPreviewMode&&!scenePreviewMode),updateNavBar(),initSlideScripts(),anyNav())}function setStep(e,t){(e=Math.max(1,Math.min(that.steps(),e)))!=stepShowing&&(t&&that.stop(),stepShowing=e,reentrantGuard||(reentrantGuard=!0,document.getElementById(divid).dispatchEvent(createEvent("stepChanged")),reentrantGuard=void 0),data.leftoff&&(variables.LastSlide=that.slide(),variables.LastStep=that.step(),storeVariables()),updateNavBar(),updateSlideVisuals(!t),"bullet"==(t=data.slides[slideShowing-1]).type?scriptProp=1==stepShowing?(scriptObj=t,"intro"):(scriptObj=t.bullets[e-2],"point"):"freeform-step"==t.type&&(scriptObj=t.steps[e-1],scriptProp="step"),anyNav())}function navNext(e){stepShowing<that.steps()?setStep(stepShowing+1,e):slideShowing<that.slides()&&setSlide(slideShowing+1,e),anyNav()}function navPrevious(e){1<stepShowing?setStep(stepShowing-1,e):1<slideShowing&&(setSlide(slideShowing-1,e),1<that.steps()&&(setStep(that.steps(),e),updateNavBar())),anyNav()}function onPlayShieldClick(){var e=document.getElementById(divid+"-playshield-canvas");e&&(e.style.display="none"),that.play()}function dispatchPlayingChanged(){document.getElementById(divid).dispatchEvent(createEvent("playingChanged"))}function preloadSlide(e){switch(e.type.split("-")[0]){case"title":case"image":case"powerpoint":preloadScript("main",e,"script");break;case"bullet":preloadScript("main",e,"intro");for(var t=0;t<e.bullets.length;t++)preloadScript(e.bullets[t],"point");break;case"choice":preloadScript("main",e,"setup");for(t=0;t<e.answers.length;t++)preloadScript(e.answers[t],"react");break;case"freeform":e.script&&preloadScript(e,"script");for(t=0;t<(e.steps||[]).length;t++)preloadScript(e.steps[t],"step")}}function preloadScript(e,t,a,i){for(var n=1;hasLine(t,a,n);){var d=getLine(t,a,n);preloadExecute(d.who&&!data.scene.suppressAlt?d.who:e,"&slide="+t.id+"&msg="+a+(i?"&answer="+i:"")+"&line="+n,d.do,d.say,d.audio),n++}}function isAgentNav(e){return"next"==e||"previous"==e||"first"==e||"goto-slide"==e||"goto-step"==e||"play"==e}function initSlideScripts(){var e=data.slides[slideShowing-1];switch(e.type){case"title":case"image":case"powerpoint":scriptObj=e,scriptProp="script";break;case"bullet":scriptObj=e,scriptProp="intro";break;case"choice":case"freeform-choice":scriptObj=e,scriptProp="setup";break;case"freeform":scriptObj=e,scriptProp="script";break;case"freeform-step":scriptObj=e.steps[0],scriptProp="step"}}function agentNav(e,t){"next"==e?navNext(!1):"previous"==e?navPrevious(!1):"first"==e?setSlide(1,!0):"goto-slide"==e?setSlide(t,!1):"goto-step"==e?setStep(t,!1):"play"==e&&that.play()}function anyNav(){scenePreviewMode||(removeAnyPrompt(),closeAnyChatArea()),playQueue=[]}function hasLine(e,t,a){return e&&(e[t]&&1<=a&&a<e[t].length||e[t]&&1<=a&&a<=e[t].length&&(e[t][a-1].do||e[t][a-1].and||e[t][a-1].say||e[t][a-1].audio))}function getLine(e,t,a){return e[t]&&1<=a&&a<=e[t].length?e[t][a-1]:{}}function playScript(){slidePlaying=slideShowing,stepPlaying=stepShowing,line=0,onScriptLineDone()}function onScriptLineDone(){var e,t,a,i;playEnding?(playEnding=!1,playing&&(playing=!1,dispatchPlayingChanged()),playOnPlayEnded&&(playOnPlayEnded=!1,playing||(playing=!0,dispatchPlayingChanged()),playScript()),updateNavBar()):(t=slideShowing!=slidePlaying,e=data.slides[slidePlaying-1],!t&&hasLine(eventObj||scriptObj,eventProp||scriptProp,line+1)?(t=getLine(eventObj||scriptObj,eventProp||scriptProp,++line),i="",i+="&msg="+(eventProp||scriptProp),eventProp||"handler"==scriptProp?i+="&event="+eventUsed:("bullet"==e.type&&"point"==scriptProp&&(i+="&bullet="+(stepShowing-1)),"choice"!=e.type&&"freeform-choice"!=e.type||"react"!=scriptProp||(i+="&answer="+(reactionUsed+1)),"freeform-step"==e.type&&(i+="&step="+stepShowing)),i="&slide="+data.slides[slidePlaying-1].id+i+"&line="+line,a=t.who&&!data.scene.suppressAlt?t.who:"main",loading[a]||animating[a]?(stopping[a]=!0,deferredExecute[a]={s:i,o:t}):execute(a,i,t.do,t.say,t.audio,onScriptLineDone)):"handler"==eventProp?(a=eventObj.event,eventUsed=eventProp=eventObj=null,"new"==a||"return"==a||"nav"==a?playing&&playScript():(playing=!1,updateNavBar(),dispatchPlayingChanged())):(i=!1,"bullet"!=e.type&&"freeform-step"!=e.type||slideShowing==slidePlaying&&stepShowing!=stepPlaying&&playing&&(scriptProp="bullet"==e.type?(scriptObj=e.bullets[stepShowing-2],"point"):(scriptObj=e.steps[stepShowing-1],"step"),playScript(),i=!0),i||(slideShowing!=slidePlaying?playing&&playScript():playing&&(playing=!1,updateNavBar(),dispatchPlayingChanged()))))}function onIdleComplete(e){var t;deferredExecute[e]?(t=deferredExecute[e],deferredExecute[e]=null,execute(e,t.s,t.o.do,t.o.say,t.o.audio,onScriptLineDone)):onPlayDone()}function dynamicPlay(e){audioContext&&audioContext.resume(),e&&("number"==typeof e.say?e.say=e.say.toString():"string"!=typeof e.say&&(e.say=""),e.say=e.say.substr(0,256),loading.main||animating.main?(playQueue.push(e),preloadExecute(e.who&&!data.scene.suppressAlt?e.who:"main","&dynamic=true",e.do,e.say,e.audio)):(playCur=e,updateNavBar(),dispatchPlayingChanged(),execute(e.who&&!data.scene.suppressAlt?e.who:"main","&dynamic=true",e.do,e.say,e.audio,onPlayDone)))}function onPlayDone(){var e;deferredEvent?(playQueue=[],e=deferredEvent,deferredEvent=playCur=null,reactToEvent(e)):(playCur&&!apogee&&onEmbeddedCommand({type:"apogee"}),0<playQueue.length?execute((playCur=playQueue.shift()).who&&!data.scene.suppressAlt?playCur.who:"main","&dynamic=true",playCur.do,playCur.say,playCur.audio,onPlayDone):playCur&&(playCur=null,updateNavBar(),dispatchPlayingChanged()))}function onEmbeddedCommand(cmd){var rec,rec=playCur||getLine(eventObj||scriptObj,eventProp||scriptProp,line);"apogee"==cmd.type?(apogee=!0,"run"==rec.and?eval(rec.script):"link"==rec.and?window.open(rec.url,rec.target):isAgentNav(rec.and)?agentNav(rec.and,rec.target):"prompt"==rec.and?doPrompt(rec.prompts):"chat"==rec.and&&openChatArea()):document.getElementById(divid).dispatchEvent(createEvent("command",cmd))}function loadBackgroundResources(e){var t;"image"==data.scene.backgroundType&&data.scene.backgroundImage?((t=new Image).onload=t.onerror=e,t.src=urlFromImage(data.scene.backgroundImage)):e()}function loadCharacterBackgroundResources(e,t){var a=data.scene[e+"BackgroundImage"];clientScale(e)&&"image"==data.scene[e+"BackgroundType"]&&a&&("main"==e||"alt"==e&&alt)?((e=new Image).onload=e.onerror=t,e.src=urlFromImage(a)):t()}function loadSlideBackgroundResources(e){var t;data.scene.slideBackgroundImage?((t=new Image).onload=t.onerror=e,t.src=urlFromImage(data.scene.slideBackgroundImage)):e()}function loadForegroundResources(e){var t;data.scene.foregroundImage?((t=new Image).onload=t.onerror=e,t.src=urlFromImage(data.scene.foregroundImage)):e()}function reactToEvent(e){for(var t,a=data.slides[slideShowing-1].events||[],i=0;i<a.length;i++)if(a[i].event==e){t=a[i];break}if(!t)for(var n=data.events||[],i=0;i<n.length;i++)if(n[i].event==e){t=n[i];break}return!!t&&(playCur?deferredEvent=e:(eventUsed=t.id,eventObj=t,eventProp="handler",("new"==e||"return"==e||"nav"==e?playScript:startScript)()),!0)}function playEvent(e){eventUsed=e.id,eventObj=e,eventProp="handler",startScript()}params.videoData?setTimeout(doVideo,0):loadData(),this.overrideIdentity=function(e){setupIdentity({enduserid:params.enduserid,identity:e})},this.pauseStartup=function(e){startupPaused=!0},this.resumeStartup=function(e){fadeInScene()},this.slide=function(e){if(void 0===e)return slideShowing||1;setSlide(e,reentrantGuard=!0),reentrantGuard=void 0},this.slides=function(){return data.slides.length},this.step=function(e){if(void 0===e)return stepShowing;setStep(e,reentrantGuard=!0),reentrantGuard=void 0},this.steps=function(){var e=data.slides[slideShowing-1];return e&&"bullet"==e.type?e.bullets.length+1:e&&"freeform-step"==e.type?e.steps.length:1},this.next=function(){navNext(!0)},this.previous=function(){navPrevious(!0)},this.first=function(){that.slide(1)},Object.defineProperty(this,"playing",{get:function(){return playing||!!playCur},set:function(e){playing=!0}}),this.play=function(){if(audioContext&&audioContext.resume(),!playing){for(var e in playing=!0,roles)resetIdleCount(e);if(updateNavBar(),dispatchPlayingChanged(),firstPlayOccurred||slidePreviewMode||(firstPlayOccurred=!0,!playGreeting())){var t=data.slides[slideShowing-1];for(e in"choice"==t.type||"freeform-choice"==t.type?(scriptObj=t,scriptProp="setup"):"freeform"==t.type&&(scriptObj=t,scriptProp="script"),roles)idling[e]&&stopAll();removeAnyPrompt(),playScript(),preload&&preloadSlide(t)}}},this.stop=function(){if(playing&&!playEnding){for(var e in playEnding=!0,stopAll(),playQueue=[],roles)resetIdleCount(e);updateNavBar()}},this.getVolume=function(){return externalGainNode.gain.value},this.setVolume=function(e){externalGainNode.gain.value=e},this.prepareToPreload=function(){preloadExecute("main","",null,null,null),preloadExecute("main","&idle=blink","blink",null,null);for(var e=getIdles("main"),t=0;t<e.length;t++)preloadExecute("main","&idle="+e[t],e[t],null,null);if(alt){e=getIdles("alt"),preloadExecute("alt","",null,null,null),preloadExecute("alt","&idle=blink","blink",null,null);for(t=0;t<e.length;t++)preloadExecute("alt","&idle="+e[t],e[t],null,null)}for(t=0;t<data.slides.length;t++)preloadSlide(data.slides[t]);return preloadQueue.length},this.preloadNext=function(e){if(0==preloadQueue.length)return e(0);preloadNextCallback=e,preloadSomeMore()},this.playEvent=function(e){for(var t=0;t<data.slides.length;t++)for(var a=0;a<(data.slides[t].events||[]).length;a++)if(data.slides[t].events[a].id==e)return playEvent(data.slides[t].events[a]);for(t=0;t<(data.events||[]).length;t++)data.events[t].id==e&&playEvent(data.events[t])};var slideImages={},slideImagesOutstanding=0;function loadSlideResources(e){loadSlideResourcesCallback=e;for(var t=0;t<data.slides.length;t++){var a=data.slides[t];switch(a.type.split("-")[0]){case"image":loadImageSlideResources(a);break;case"powerpoint":loadPowerpointSlideResources(a);break;case"freeform":loadFreeformSlideResources(a)}}0==slideImagesOutstanding?e():loadSlideResourcesCallback=e}function checkDoneLoadingSlideResources(){var e;0==slideImagesOutstanding&&(e=loadSlideResourcesCallback,loadSlideResourcesCallback=null,e())}function updateSlideVisuals(e){var t=document.getElementById(divid+"-slide-holder");if(t){for(var a,i,n,d,s,o=0;o<t.children.length;o++)t.children[o].style.display=o+1==slideShowing||visualsPreviewMode?"block":"none";slideShowing&&(o=slideShowing-1,a=t.children[o],n=i=!1,"bullet"==data.slides[o].type?(i=e&&1<stepShowing,setBulletSlideStep(data.slides[o],a.firstChild,stepShowing,i)):"freeform-step"==data.slides[o].type&&(n=e&&1<stepShowing,visualsPreviewMode||setFreeformSlideStep(data.slides[o],a.firstChild,stepShowing,n)),!e||i||n||("cross"==(e=data.slides[o].transition||"fade")&&0<o?(s=t.children[o-1],d=o-1,t.appendChild(s),crossFade(s,a,250,function(){t.insertBefore(s,t.children[d])})):"fade"==e&&0==o?fadeIn(a,250,function(){}):"fade"==e&&0<o&&((s=t.children[o-1]).style.display="block",a.style.display="none",fadeOut(s,125,function(){s.style.display="none",s.style.visibility="",a.style.display="block",fadeIn(a,125,function(){})}))))}}function setupSlides(){for(var e="",t=0;t<data.slides.length;t++){var a=data.slides[t],e=e+('<div id="'+divid+"-slide"+(t+1)+'" style="position:absolute; top:0; left:0; width:'+cxSlide+"px; height:"+cySlide+'px;">')+('<div style="width:'+cxSlide+"px; height:"+cySlide+'px; position:relative">');switch(a.type.split("-")[0]){case"title":e+=renderTitleSlide(a);break;case"image":e+=renderImageSlide(a);break;case"powerpoint":e+=renderPowerpointSlide(a);break;case"bullet":e+=renderBulletSlide(a);break;case"choice":e+=renderChoiceSlide(a);break;case"freeform":e+=renderFreeformSlide(a)}e=e+"</div>"+"</div>"}var i=document.getElementById(divid+"-slide-holder");for(i.innerHTML=e,t=0;t<data.slides.length;t++){var a=data.slides[t],n=i.children[t].firstChild;switch(a.type.split("-")[0]){case"title":initTitleSlide(a,n);break;case"image":initImageSlide(a,n);break;case"powerpoint":initPowerpointSlide(a,n);break;case"bullet":initBulletSlide(a,n);break;case"choice":initChoiceSlide(a,n);break;case"freeform":initFreeformSlide(a,n)}visualsPreviewMode&&(n.onmousedown=function(e){document.getElementById(divid).dispatchEvent(createEvent("focus",{target:null}))})}}function bindSlides(){for(var e=document.getElementById(divid+"-slide-holder"),t=0;t<data.slides.length;t++){var a=data.slides[t],i=e.children[t].firstChild;"choice"===a.type&&bindChoiceSlide(a,i)}}function isScoringSlide(e){e=data.slides[e-1];return e&&"choice"==e.type}function isSlideAnswered(e){var t,a=data.slides[e-1];if(a)return(t=document.getElementById(divid+"-slide-holder")).children[e-1].firstChild,"choice"===a.type&&isQuestionSlideAnswered(a,t)}function getSlideScore(e){var t=data.slides[e-1];return t&&(e=document.getElementById(divid+"-slide-holder").children[e-1].firstChild,"choice"===t.type)?getQuestionSlideScore(t,e):0}function updateStylesheet(){var e="",t=(e=(e=(e=(e+=styleHelper("submit","medsemStdBtnStyle1"))+styleHelper("generic","medsemStdBtnStyle1"))+styleHelper("promptButton","medsemStdBtnStyle1"))+styleHelper("promptBacker","medsemStdPromptBackerStyle1"),"medsem"+moduleid+"Styles"),a=document.head||document.getElementsByTagName("head")[0],i=document.querySelector("#"+t);i&&a.removeChild(i),a.appendChild(createStyleElement(t,e))}var styleInfo={medsemStdBtnStyle1:".medsemStdBtnStyle1{}",medsemStdBtnStyle2:".medsemStdBtnStyle2{box-shadow:inset 0 -3px 7px 0 #29bbff;background:linear-gradient(to bottom,#2dabf9 5%,#0688fa 100%);background-color:#2dabf9;border-radius:3px;border:1px solid #0b0e07;display:inline-block;cursor:pointer;color:#fff;font-family:Arial;font-size:15px;padding:9px 23px;text-decoration:none;text-shadow:0 1px 0 #263666}.medsemStdBtnStyle2:hover{background:linear-gradient(to bottom,#0688fa 5%,#2dabf9 100%);background-color:#0688fa}.medsemStdBtnStyle2:active{position:relative;top:1px}",medsemStdBtnStyle3:".medsemStdBtnStyle3{box-shadow:0 1px 0 0 #1c1b18;background:linear-gradient(to bottom,#eae0c2 5%,#ccc2a6 100%);background-color:#ffe0c2;border-radius:15px;border:2px solid #333029;display:inline-block;cursor:pointer;color:#505739;font-family:Arial;font-size:14px;font-weight:bold;padding:12px 16px;text-decoration:none;text-shadow:0 1px 0 #fff;user-select:none}.medsemStdBtnStyle3:hover{background:linear-gradient(to bottom,#ccc2a6 5%,#eae0c2 100%);background-color:#ccc2a6}.medsemStdBtnStyle3:active{position:relative;top:1px}",medsemStdPromptBackerStyle1:".medsemStdPromptBackerStyle1 {} .medsemStdPromptBackerStyle1 > button {margin: 0 10px 0 10px}",medsemStdPromptBackerStyle2:".medsemStdPromptBackerStyle2 {box-shadow:inset 0px 1px 0px 0px #ffffff;background:linear-gradient(to bottom,#ededed 5%,#dfdfdf 100%);background-color:#ededed;border-radius:6px;border:1px solid #dcdcdc;padding:10px 10px;} .medsemStdPromptBackerStyle2 > button {margin: 0 10px 0 10px}",medsemStdPromptBackerStyle3:".medsemStdPromptBackerStyle3 {box-shadow: 0px 0px 0px 2px #9fb4f2;background:linear-gradient(to bottom, #7892c2 5%, #476e9e 100%);background-color:#7892c2;border-radius:10px;border:1px solid #4e6096;padding:10px 10px;} .medsemStdPromptBackerStyle3 > button {margin: 0 10px 0 10px}"},navBarImg,navBarMap;function styleHelper(e,t){t=data.style[e+"Style"]||t;return(styleInfo[t]||data.style[e+"CSS"]||"").replaceAll(t,"medsem"+moduleid+e)}function createStyleElement(e,t){var a=document.createElement("style");return a.type="text/css",a.id=e,a.styleSheet?a.styleSheet.cssText=t:a.appendChild(document.createTextNode(t)),a}function textColor(){return data.style.textColor||"#000000"}function titleFont(){return data.style.titleFont||"Arial, Helvetica, sans-serif"}function bodyFont(){return data.style.bodyFont||"Arial, Helvetica, sans-serif"}function sansFont(){return data.style.sansFont||"Arial, Helvetica, sans-serif"}function serifFont(){return data.style.serifFont||"Times New Roman, Times, serif"}function monoFont(){return data.style.monoFont||"Courier New, Courier, monospace"}function cssClass(e,t){return"medsem"+moduleid+e}function styleText(e,t){return data.style[e+"Text"]||t}function renderTitleSlide(e){var t="";return(t+='<div class="title" style="text-align:center; position:absolute; color:'+textColor()+'">'+(e.title||"")+"</div>")+('<div class="subtitle" style="text-align:center; position:absolute; color:'+textColor()+'">'+(e.subtitle||"")+"</div>")}function initTitleSlide(e,t){for(var a=t.querySelector(".title"),i=(a.style.width=.9*cxSlide+"px",a.style.left=.05*cxSlide+"px",Math.min(cxSlide,cySlide)/10);a.style.font=i--+"px "+titleFont(),10<i&&a.offsetHeight>.25*cySlide;);var n,d=a.offsetHeight,s=0,o=0;if(e.subtitle){for(s=.05*cySlide,(n=t.querySelector(".subtitle")).style.width=.9*cxSlide+"px",n.style.left=.05*cxSlide+"px",i-=4;n.style.font=i--+"px "+titleFont(),10<i&&n.offsetHeight>.4*cySlide;);o=n.offsetHeight}e=cySlide-d-s-o;a.style.top=.03*-cySlide+e/2+"px",n&&(n.style.top=.03*-cySlide+e/2+d+s+"px")}function loadImageSlideResources(e){var t;e.image&&(t=urlFromImage(e.image))&&(slideImages[e.id]=new Image,slideImagesOutstanding++,slideImages[e.id].onload=slideImages[e.id].onerror=function(){slideImagesOutstanding--,checkDoneLoadingSlideResources()},slideImages[e.id].src=t)}function renderImageSlide(e){var t="";return t+='<div class="image" style="position:absolute;"></div>',e.title&&(t+='<div class="title" style="text-align:center; position:absolute; color:'+textColor()+'">'+(e.title||"")+"</div>"),t}function initImageSlide(e,t){var a,i=e.scaling||"none",n=slideImages[e.id],d=e.image&&n?slideImages[e.id].width:0,s=e.image&&n?slideImages[e.id].height:0,o=0,r=0;if(e.title){(a=t.querySelector(".title")).style.width=.9*cxSlide+"px",a.style.left=.05*cxSlide+"px";for(var l=cxSlide/10;a.style.font=l--+"px "+titleFont(),10<l&&a.offsetHeight>.25*cySlide;);o=a.offsetHeight,a.style.top=.03*-cySlide+(cySlide-o)/2+"px",r="none"==i&&s<.5*cySlide?.05*cySlide:.025*cySlide}e.image&&n&&((n=t.querySelector(".image")).style.backgroundImage='url("'+slideImages[e.id].src+'")',n.style.backgroundRepeat="no-repeat",n.style.overflow="hidden","all"==i?(n.style.width=cxSlide+"px",n.style.height=cySlide+"px",n.style.backgroundSize="cover",n.style.backgroundPosition="center"):"most"==i?(t=.9*cySlide-o,e=.9*cxSlide,s*=t=Math.min(t/s,e/d),n.style.width=(d*=t)+"px",n.style.height=s+"px",n.style.backgroundSize="cover",n.style.backgroundPosition="center",n.style.left=(cxSlide-d)/2+"px"):"none"==i&&(d=Math.min(cxSlide,d),s=Math.min(cySlide,s),n.style.width=d+"px",n.style.height=s+"px",n.style.left=(cxSlide-d)/2+"px",n.style.top=(cySlide-s)/2+"px"),"most"==i&&(e=cySlide-o-r-s,a&&(a.style.top=e/2+"px"),n.style.top=e/2+o+r+"px"))}function loadPowerpointSlideResources(e){var t;e.powerpoint&&(t=urlFromPowerpoint(e.powerpoint,e.slideIndex||1))&&(slideImages[e.id]=new Image,slideImagesOutstanding++,slideImages[e.id].onload=slideImages[e.id].onerror=function(){slideImagesOutstanding--,checkDoneLoadingSlideResources()},slideImages[e.id].src=t)}function renderPowerpointSlide(e){return'<div class="image" style="position:absolute;"></div>'}function initPowerpointSlide(e,t){e.scaling;var a=slideImages[e.id];e.powerpoint&&a&&slideImages[e.id].width,e.powerpoint&&a&&slideImages[e.id].height;e.powerpoint&&a&&((a=t.querySelector(".image")).style.backgroundImage='url("'+slideImages[e.id].src+'")',a.style.backgroundRepeat="no-repeat",a.style.overflow="hidden",a.style.width=cxSlide+"px",a.style.height=cySlide+"px",a.style.backgroundSize="cover",a.style.backgroundPosition="center")}function renderBulletSlide(e){var t="";if(e.title&&(t+='<div class="title" style="text-align:center; position:absolute; color:'+textColor()+'">'+(e.title||"")+"</div>"),e.bullets){for(var t=t+('<div class="bullets" style="position:absolute; overflow:hidden; color:'+textColor()+'">')+"<ul>",a=0;a<e.bullets.length;a++)a==e.bullets.length-1&&!e.bullets[a].text||(t+='<li class="bullet">'+e.bullets[a].text+"</li>");t=t+"</ul>"+"</div>"}return t}function initBulletSlide(e,t){var a,i=0,n=0;if(e.title){(a=t.querySelector(".title")).style.width=.9*cxSlide+"px",a.style.left=.05*cxSlide+"px";for(var d=Math.min(cxSlide,cySlide)/10;a.style.font=d--+"px "+titleFont(),10<d&&a.offsetHeight>.25*cySlide;);i=a.offsetHeight,n=.05*cySlide}if(e.bullets){var s=t.querySelector(".bullets");for(s.style.width=.9*cxSlide+"px",d=Math.min(cxSlide,cySlide)/10;s.style.font=d--+"px "+bodyFont(),10<d&&(s.offsetWidth>.95*cxSlide||s.offsetHeight>.7*cySlide););s.style.left=(cxSlide-s.offsetWidth)/2+"px";e=s.offsetHeight,t=cySlide-i-n-e,e=(a&&(a.style.top=t/2+"px"),t/2+i+n);s.style.top=e+"px",s.style.height=Math.min(s.offsetHeight,cySlide-e)+"px"}}function setBulletSlideStep(e,t,a,i){for(var n=t.querySelectorAll(".bullet"),d=0;d<n.length;d++)n[d].style.visibility=d<=a-2||visualsPreviewMode?"visible":"hidden";i&&1<a&&fadeIn(n[a-2],250,function(){})}function renderChoiceSlide(e){var t="";if(e.title&&(t+='<div class="title" style="text-align:center; position:absolute;color:'+textColor()+'">'+(e.title||"")+"</div>"),t+='<div class="flow" style="position:absolute; overflow:hidden">',e.question&&(t+='<div class="question" style="color:'+textColor()+'"><p>'+(e.question||"")+"</p></div>"),e.answers){for(var a=0;a<e.answers.length;a++)t=(t=(t+='<div style="width:100%; margin-top:5px">')+'<div style="display:table-cell; width:2em"><input type="radio" name="answer" value="'+a+'"> <span style="position:relative;top:0px;color:'+textColor()+'">'+letterFor(a)+"</span></div>")+'<div style="display:table-cell; width:calc(100%-2em); color:'+textColor()+'">'+(e.answers[a].text||"")+"</div></div>",a==e.answers.length-1&&e.answers[a].text;t=(t+="<br>")+('<div style="text-align:center; width:100%; margin:2px"><button class="'+cssClass("submit")+'">'+styleText("submit","Submit")+"</button></div>")}return t+="</div>"}function initChoiceSlide(e,t){var a,i=0,n=.05*cySlide;if(e.title){(a=t.querySelector(".title")).style.width=.9*cxSlide+"px",a.style.left=.05*cxSlide+"px",a.style.top=n+"px";for(var d=Math.min(cxSlide,cySlide)/10;a.style.font=d--+"px "+titleFont(),10<d&&a.offsetHeight>.25*cySlide;);i=a.offsetHeight,n+=a.offsetHeight+.05*cySlide}var s=t.querySelector(".flow");for(s.style.width=.9*cxSlide+"px",d=Math.min(cxSlide,cySlide)/10;s.style.font=d--+"px "+bodyFont(),10<d&&(s.offsetWidth>.95*cxSlide||s.offsetHeight>cySlide*(i?.7:.9)););s.style.left=.05*cxSlide+"px",s.style.height=Math.min(s.offsetHeight,cySlide-n)+"px",s.style.top=n+"px",visualsPreviewMode||t.querySelector("."+cssClass("submit")).addEventListener("click",onQuestionSlideSubmit.bind(null,t))}function bindChoiceSlide(e,t){if(e.variable&&variables[e.variable])for(var a=t.querySelectorAll("input"),i=0;i<a.length;i++)a[i].checked=variables[e.variable]==String.fromCharCode("A".charCodeAt(0)+i)}function letterFor(e){return String.fromCharCode("A".charCodeAt(0)+e)}function indexFor(e){return e?e.charCodeAt(0)-"A".charCodeAt(0):void 0}function onQuestionSlideSubmit(e){for(var t=e.querySelectorAll("input"),a=0;a<t.length;a++)if(t[a].checked){if(answerChosen=parseInt(t[a].value),isNaN(answerChosen))return;var i=data.slides[slideShowing-1],n=(i.variable&&setVariable(i.variable,String.fromCharCode("A".charCodeAt(0)+answerChosen)),reactionUsed=answerChosen,i.answers[answerChosen].sameAs);if(n)for(var d=0;d<i.answers.length;d++)if(i.answers[d].id==n){reactionUsed=d;break}scriptObj=i.answers[reactionUsed],scriptProp="react",startScript();break}}function startScript(){if(playing)playOnPlayEnded=!0,that.stop();else{for(var e in playing=!0,updateNavBar(),dispatchPlayingChanged(),removeAnyPrompt(),roles)idling[e]&&stopAll();playScript()}}function isQuestionSlideAnswered(e,t){for(var a=t.querySelectorAll("input"),i=0;i<a.length;i++)if(a[i].checked)return!0;return!1}function getQuestionSlideScore(e,t){for(var a=t.querySelectorAll("input"),i=0;i<a.length;i++)if(a[i].checked)return e.answers[i].id==e.correct?1:0;return 0}function loadFreeformSlideResources(e){for(var t=0;t<e.items.length;t++){var a=e.items[t],i=divid+"-"+e.id+"-"+t;"image"!=a.type||(a=urlFromImage(a.image))&&(slideImages[i]=new Image,slideImagesOutstanding++,slideImages[i].onload=slideImages[i].onerror=function(){slideImagesOutstanding--,checkDoneLoadingSlideResources()},slideImages[i].src=a)}}function callExtension(e){for(var t=0;t<extensions.length;t++)if("function"==typeof extensions[t][e]){var a=extensions[t][e].apply(null,Array.from(arguments).slice(1));if(null!==a)return a}return null}function renderFreeformSlide(e){for(var t="",a=0;a<e.items.length;a++){var i=e.items[a],n=divid+"-"+e.id+"-"+a;"image"==i.type?t+='<div id="'+n+'" data-type="image" style="position:absolute;"></div>':"text"==i.type?t+='<div id="'+n+'" data-type="text" style="position:absolute;">'+translateHTML(i.text)+"</div>":"choice"==i.type?t+='<div id="'+n+'" data-type="choice" style="position:absolute;"><input type="radio" name="answer" value="'+indexFor(i.letter)+'"></div>':"submit"==i.type?t+='<div id="'+n+'" data-type="submit" style="position:absolute;"><button class="'+cssClass("submit")+'">'+styleText("submit","Submit")+"</button></div>":"button"==i.type?t+='<div id="'+n+'" data-type="button" style="position:absolute;"><button class="'+cssClass("generic")+'">'+(i.label||"&nbsp;")+"</button></div>":"iframe"==i.type?t+='<div id="'+n+'" data-type="iframe" style="position:absolute;border:none;"><iframe src="'+(i.url||"")+'" height="'+i.height+'" width="'+i.width+'" style="border:none;"></iframe></div>':t+=callExtension("renderFreeformSlideItem",e,i,n)||""}return t}function initFreeformSlide(e,t){for(var a=0;a<e.items.length;a++){var i,n=e.items[a],d=divid+"-"+e.id+"-"+a,s=document.getElementById(d);"image"==n.type?(slideImages[d]?s.style.backgroundImage='url("'+slideImages[d].src+'")':(i="<svg xmlns='http://www.w3.org/2000/svg' preserveAspectRatio='none' viewBox='0 0 "+n.width+" "+n.height+"' width='"+n.width+"' height='"+n.height+"'><rect width='"+n.width+"' height='"+n.height+"' style='fill:rgb(128,128,128);'/></svg>",s.style.backgroundImage='url("data:image/svg+xml;utf8,'+i+'")'),s.style.backgroundRepeat="no-repeat",s.style.overflow="hidden",s.style.backgroundSize="cover",s.style.backgroundPosition="center",s.style.width=n.width+"px",s.style.height=n.height+"px",s.style.left=n.x+"px",s.style.top=n.y+"px"):"text"==n.type?(void 0!==n.width?(s.style.width=n.width+"px",s.style.whiteSpace=""):(s.style.width="",s.style.whiteSpace="nowrap"),s.style.left=n.x+"px",s.style.top=n.y+"px",s.style.userSelect=visualsPreviewMode?"none":"",s.style.color=textColor(),s.style.fontFamily=sansFont()):"choice"==n.type?(s.style.left=n.x+"px",s.style.top=n.y+"px"):"submit"==n.type?(s.style.left=n.x+"px",s.style.top=n.y+"px",visualsPreviewMode||t.querySelector("."+cssClass("submit")).addEventListener("click",onQuestionSlideSubmit.bind(null,t))):"button"==n.type?(s.style.left=n.x+"px",s.style.top=n.y+"px",visualsPreviewMode||t.querySelector("#"+d).addEventListener("click",onFreeformButtonClick.bind(null,n.event))):"iframe"==n.type?(s.style.left=n.x+"px",s.style.top=n.y+"px",visualsPreviewMode&&(s.firstChild.style.pointerEvents="none")):callExtension("initFreeformSlideItem",e,n,d,s),s&&visualsPreviewMode&&(s.onmousedown=dispatchFocusEvent.bind(this,a))}visualsPreviewMode&&updateAuthorFreeformSlideVisibility(e)}function updateAuthorFreeformSlideVisibility(e){for(var t=e.steps[stepPreview-1].id,a="step"==e.type.split("-")[1],i=0;i<e.items.length;i++){var n=e.items[i],d=divid+"-"+e.id+"-"+i,d=document.getElementById(d);d&&(d.style.visibility=!a||workMode?1==n.visible||void 0===n.visible?"visible":"hidden":n.steps&&-1<n.steps.indexOf(t)?"visible":"hidden")}}function setFreeformSlideStep(e,t,a,i){for(var n=e.steps[a-1].id,d=0;d<e.items.length;d++){var s=e.items[d],o=divid+"-"+e.id+"-"+d,o=document.getElementById(o),s=s.steps&&-1<s.steps.indexOf(n);o.style.visibility=s?"visible":"hidden",i&&1<a&&(s?fadeIn:fadeOut)(o,250,function(){})}}function dispatchFocusEvent(e,t){document.getElementById(divid).dispatchEvent(createEvent("focus",{target:"item-"+e})),t.stopPropagation()}function translateHTML(e){if(!e)return"";for(var t;null!=(t=e.match(/class="([^"]*)"/));){for(var a=t[1].split(" "),i="",n=0;n<a.length;n++){var d=a[n];"ql-font-serif"==d?i+="font-family: "+serifFont():"ql-font-monospace"==d?i+="font-family: "+monoFont():"ql-size-small"==d?i+="font-size: 0.75em;":"ql-size-large"==d?i+="font-size: 1.5em;":"ql-size-huge"==d?i+="font-size: 2.5em;":"ql-align-center"==d?i+="text-align: center;":"ql-align-justify"==d?i+="text-align: justify;":"ql-align-right"==d?i+="text-align: right;":"katex-html"==d&&(i+="display:none;")}e=e.replace(t[0],'style="'+i+'"')}for(;null!=(t=e.match(/style="([^"]*)" style="([^"]*)"/));)e=e.replace(t[0],'style="'+t[1]+" "+t[2]+'"');return e=null!=(t=(e=null!=(t=e.match(/^<p><br><\/p>$/))?e.replace(t[0],"<span><br></span>"):e).match(/^<p>(.*?)<\/p>$/))?e.replace(t[0],"<span>"+t[1]+"</span>"):e}function onFreeformButtonClick(e){reactToEvent(e)}function loadVideoResources(e){var t;data.scene.video?((t=new Image).onload=t.onerror=e,t.src=urlFromVideo(data.scene.video)):e()}function urlFromVideo(e){return e?"stock:"==(e=e.replace(".mp4",".jpeg")).substr(0,6)?(mediaBase?mediaBase+"stock/video/":"cb/"+moduleid+"/")+e.replace("stock:",""):"file:"==e.substr(0,5)?(mediaBase?mediaBase+userid+"/video/":"cb/"+moduleid+"/")+e.replace("file:",""):"":""}function liveAdjustVideo(e,t){var a=document.getElementById(divid+"-video");"video"==e?a.src=urlFromVideo(t):"left"==e?a.style.left=t+"px":"top"==e?a.style.top=t+"px":"width"==e?a.style.width=t+"px":"height"==e&&(a.style.height=t+"px")}function scoringSlides(){if(!data)return 0;for(var e=0,t=0;t<data.slides.length;t++)isScoringSlide(t+1)&&e++;return e}function slidesAnswered(){if(!data)return 0;for(var e=0,t=0;t<data.slides.length;t++)isScoringSlide(t+1)&&isSlideAnswered(t+1)&&e++;return e}function slidesAnsweredCorrectly(){if(!data)return 0;for(var e=0,t=0;t<data.slides.length;t++)isScoringSlide(t+1)&&(e+=getSlideScore(t+1));return e}this.scoringSlides=scoringSlides,this.slidesAnswered=slidesAnswered,this.slidesAnsweredCorrectly=slidesAnsweredCorrectly;var navBtns={first:!0,play:!0,previous:!0,stop:!0,next:!0};function loadNavBarResources(t){var a;data.scene.navbar||scenePreviewMode?(a="standard",(navBarImg=new Image).onload=function(){var e=new XMLHttpRequest;e.onload=function(){navBarMap=JSON.parse(e.response),t()},e.open("GET",(mediaBase?mediaBase+"navbars/":"cb/"+moduleid+"/")+a+".json",!0),e.send()},navBarImg.src=(mediaBase?mediaBase+"navbars/":"cb/"+moduleid+"/")+a+".png"):t()}function makeImageDiv(e,t,a,i,n,d,s){e='<div id="'+e+"-"+i+'"';return e+=' style="width:'+a[i].width+"px; height:"+a[i].height+"px;",s&&(e+=" transform-origin: top left; transform: scaleX("+s/a[i].width+");"),e=(e=e+(" background-position: "+a[i].offset_x+"px "+a[i].offset_y+"px;")+(" position:absolute; top:"+d+"px; left:"+n+"px; background-image:url("))+("'"+t.src+"'")+');"></div>'}function updateDivImage(e,t,a){e.style.backgroundPosition=t[a].offset_x+"px "+t[a].offset_y+"px"}function renderNavBar(e){var t,a="",i=divid+"-navbar";return"standard"==e?(t=navBarMap["bar-mid"].height,a=(a=(a=(a=(a=(a=(a=(a=(a=(a=a+('<div id="'+i+'" style="position:absolute; left:0; top:'+(data.height-t)+"px; width:"+data.width)+"px; height:"+t+"px;"+("standard"==e?"display:block":"display:none")+'">  <div style="position:relative;">')+makeImageDiv(i,navBarImg,navBarMap,"bar-left",0,0))+makeImageDiv(i,navBarImg,navBarMap,"bar-mid",navBarMap["bar-left"].width,0,data.width-(navBarMap["bar-left"].width+navBarMap["bar-right"].width)))+makeImageDiv(i,navBarImg,navBarMap,"bar-right",data.width-navBarMap["bar-right"].width,0))+makeImageDiv(i,navBarImg,navBarMap,"first",navBarMap.first.x,0))+makeImageDiv(i,navBarImg,navBarMap,"play",navBarMap.play.x,0))+makeImageDiv(i,navBarImg,navBarMap,"previous",data.width-640+navBarMap.previous.x,0))+makeImageDiv(i,navBarImg,navBarMap,"stop",data.width-640+navBarMap.stop.x,0))+makeImageDiv(i,navBarImg,navBarMap,"next",data.width-640+navBarMap.next.x,0))+'<div id="'+i+'-text" style="user-select:none; '+navBarMap.text.style+" width:"+navBarMap.text.width+"px; height:"+t+"px; position:absolute; top:0px; left:"+(data.width-640+navBarMap.text.x)+'px;"></div>  </div></div>'):a+='<div id="'+i+'"></div>',a}function setupNavBar(){if(data.scene.navbar)for(var e in navBtns){var t=document.getElementById(divid+"-navbar-"+e);t.onmouseenter=onNavMouseEnter.bind(that,e),t.onmousedown=onNavMouseDown.bind(that,e),t.onmouseleave=onNavMouseLeave.bind(that,e),t.onclick=onNavClick.bind(that,e)}}function liveAdjustNavBar(){document.getElementById(divid+"-navbar").outerHTML=renderNavBar(data.scene.navbar),setupNavBar()}function onNavMouseEnter(e){document.getElementById(divid+"-navbar-"+e).style.cursor="pointer"}function onNavMouseDown(e){updateDivImage(document.getElementById(divid+"-navbar-"+e),navBarMap,e+"-down")}function onNavMouseLeave(e){updateDivImage(document.getElementById(divid+"-navbar-"+e),navBarMap,e+(navBtns[e]?"":"-disabled"))}function onNavClick(e){for(var t in roles)resetIdleCount(t);"play"==e&&document.getElementById(divid).dispatchEvent(createEvent("playPressed"))?that.play():"stop"==e&&document.getElementById(divid).dispatchEvent(createEvent("stopPressed"))?that.stop():"next"==e&&document.getElementById(divid).dispatchEvent(createEvent("nextPressed"))?that.next():"previous"==e&&document.getElementById(divid).dispatchEvent(createEvent("previousPressed"))?that.previous():"first"==e&&document.getElementById(divid).dispatchEvent(createEvent("firstPressed"))&&that.first()}function updateNavBar(){var e,t;data.scene.navbar&&(enableNavBarBtn("play",!scenePreviewMode&&!(playing||playCur)),enableNavBarBtn("stop",(playing||!!playCur)&&!playEnding),enableNavBarBtn("first",1<slideShowing||1<stepShowing),enableNavBarBtn("previous",1<slideShowing||1<stepShowing),enableNavBarBtn("next",slideShowing<that.slides()||stepShowing<that.steps()),scenePreviewMode||slidePreviewMode||(e=slideShowing+"/"+that.slides(),1==that.slides()&&1<that.steps()&&(e=stepShowing+"/"+that.steps()),(t=document.getElementById(divid+"-navbar-text"))&&(t.innerHTML=e)))}function enableNavBarBtn(e,t){var a=document.getElementById(divid+"-navbar-"+e);a&&(updateDivImage(a,navBarMap,t?e:e+"-disabled"),a.style.pointerEvents=t?"auto":"none",navBtns[e]=t)}function updateHighlight(){var s,e,t,o,r,d,l,c,a,u,p,i,n,h=document.getElementById(divid+"-highlight-div"),m=document.getElementById(divid+"-highlight-div-x-resize"),g=document.getElementById(divid+"-highlight-div-y-resize");h&&(s=visualsPreviewMode?2:0,d=r=o=null,a=c=l=t=e=i=!1,"background"==highlight&&(p=document.getElementById(divid+"-background-div")),"misc"==highlight?p=document.getElementById(divid+"-background-div"):"main"==highlight?(p=document.getElementById(divid+"-main-clip-div"),t=e=i=!0,o=data.scene,r="main",d=document.getElementById(divid+"-main-background-div")):"alt"==highlight?(p=document.getElementById(divid+"-alt-clip-div"),t=e=i=!0,o=data.scene,r="alt",d=document.getElementById(divid+"-alt-background-div")):"slide"==highlight?(p=document.getElementById(divid+"-slide-area"),l=t=e=i=!0):"slidestyle"==highlight?p=document.getElementById(divid+"-slide-area"):"nav"==highlight?p=document.getElementById(divid+"-navbar"):"prompts"==highlight?(doPrompt([{label:"Option"},{label:"Option"}]),p=document.getElementById(divid+"-prompt-shelf"),a=!0):"chat"==highlight?data.scene.chatArea&&(liveAdjustChatArea(),p=document.getElementById(divid+"-popup-container"),a=!0):"video"==highlight?(p=document.getElementById(divid+"-video"),o=data.scene,r="video",c=t=e=i=!0):highlight&&"item-"==highlight.substr(0,5)&&(u=divid+"-"+data.slides[0].id+"-"+highlight.substr(5),i=!0,"choice"!=(n=(p=document.getElementById(u)).getAttribute("data-type"))&&"submit"!=n&&(e=p&&!("text"==p.getAttribute("data-type")&&"nowrap"==p.style.whiteSpace),t=p&&!("text"==p.getAttribute("data-type")))),"chat"!=highlight&&isPopupOpen()&&(liveAdjustChatArea(),closeAnyChatArea()),"prompts"!=highlight&&removeAnyPrompt(),p?a?(h.style.top=p.style.top,h.style.left=p.style.left,h.style.right=p.style.right,h.style.bottom=p.style.bottom,h.style.width=p.offsetWidth+"px",h.style.height=p.offsetHeight+"px",h.style.visibility=p.style.visibility,h.style.transform=p.style.transform,h.style.margin=p.style.margin):(h.style.top=parseInt(p.style.top)-s+"px",h.style.left=parseInt(p.style.left)-s+"px",h.style.width=p.clientWidth+2*s+"px",h.style.height=p.clientHeight+2*s+"px",h.style.visibility=p.style.visibility,h.style.transform="",h.style.margin=""):h.style.visibility="hidden",m.style.visibility=e?h.style.visibility:"hidden",g.style.visibility=t?h.style.visibility:"hidden",repositionResizeDivs(h,m,g),h.style.cursor=i?"move":"auto",p&&i?(h.ondragstart=function(){return!1},h.onmousedown=function(e){var t=e.pageX,a=e.pageY,i=parseInt(h.style.left),n=parseInt(h.style.top);function d(e){h.style.left=i+(e.pageX-t)+"px",h.style.top=n+(e.pageY-a)+"px",repositionResizeDivs(h,m,g),p.style.top=parseInt(h.style.top)+s+"px",p.style.left=parseInt(h.style.left)+s+"px",highlight&&document.getElementById(divid).dispatchEvent(createEvent("drag",{target:highlight,done:!1,x:parseInt(p.style.left),y:parseInt(p.style.top)}))}document.addEventListener("mousemove",d),document.addEventListener("mouseup",function e(t){document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",e),o&&(o[r+(l?"Left":"X")]=parseInt(p.style.left),o[r+(l?"Top":"Y")]=parseInt(p.style.top)),document.getElementById(divid).dispatchEvent(createEvent("drag",{target:highlight,done:!0,x:parseInt(p.style.left),y:parseInt(p.style.top)}))})}):(h.ondragstart=null,h.onmousedown=null),p&&e&&(m.ondragstart=function(){return!1},m.onmousedown=function(e){var i=e.pageX,n=parseInt(h.style.width);function a(e){var t,a;h.style.width=n+(e.pageX-i)+"px","text"==p.getAttribute("data-type")&&(h.style.height=p.clientHeight+"px"),"image"==p.getAttribute("data-type")&&slideImages[u]&&(t=(parseInt(h.style.width)-2*s)/slideImages[u].naturalWidth,a=Math.round(slideImages[u].naturalHeight*t),h.style.height=a+2*s+"px"),c&&(t=parseInt(h.style.width)/data.scene.videoNaturalWidth,a=Math.round(data.scene.videoNaturalHeight*t),h.style.height=a+"px"),repositionResizeDivs(h,m,g),p.style.width=parseInt(h.style.width)-2*s+"px","iframe"==p.getAttribute("data-type")&&(p.firstChild.width=parseInt(p.style.width)),"image"!=p.getAttribute("data-type")&&!c||(p.style.height=parseInt(h.style.height)-2*s+"px"),d&&(d.style.width=p.style.width),l&&(cxSlide=parseInt(p.style.width),setupSlides(),updateSlideVisuals(!1)),highlight&&document.getElementById(divid).dispatchEvent(createEvent("resizex",{target:highlight,done:!1,width:parseInt(p.style.width),height:parseInt(p.style.height)}))}document.addEventListener("mousemove",a),document.addEventListener("mouseup",function e(t){document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",e),o&&(o[r+"Width"]=parseInt(p.style.width),o[r+"Height"]=parseInt(p.style.height)),document.getElementById(divid).dispatchEvent(createEvent("resizex",{target:highlight,done:!0,width:parseInt(p.style.width),height:parseInt(p.style.height)}))})}),p&&t&&(g.ondragstart=function(){return!1},g.onmousedown=function(e){var i=e.pageY,n=parseInt(h.style.height);function a(e){var t,a;h.style.height=n+(e.pageY-i)+"px","image"==p.getAttribute("data-type")&&slideImages[u]&&(t=(parseInt(h.style.height)-2*s)/slideImages[u].naturalHeight,a=Math.round(slideImages[u].naturalWidth*t),h.style.width=a+2*s+"px"),c&&(t=parseInt(h.style.height)/data.scene.videoNaturalHeight,a=Math.round(data.scene.videoNaturalWidth*t),h.style.width=a+"px"),repositionResizeDivs(h,m,g),p.style.height=parseInt(h.style.height)-2*s+"px","iframe"==p.getAttribute("data-type")&&(p.firstChild.height=parseInt(p.style.height)),"image"!=p.getAttribute("data-type")&&!c||(p.style.width=parseInt(h.style.width)-2*s+"px"),d&&(d.style.height=p.style.height),l&&(cySlide=parseInt(p.style.height),setupSlides(),updateSlideVisuals(!1)),highlight&&document.getElementById(divid).dispatchEvent(createEvent("resizey",{target:highlight,done:!1,height:parseInt(p.style.height),width:parseInt(p.style.width)}))}document.addEventListener("mousemove",a),document.addEventListener("mouseup",function e(t){document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",e),o&&(o[r+"Height"]=parseInt(p.style.height),o[r+"Width"]=parseInt(p.style.width)),document.getElementById(divid).dispatchEvent(createEvent("resizey",{target:highlight,done:!0,height:parseInt(p.style.height),width:parseInt(p.style.width)}))})}),liveAdjustPlayShield())}function repositionResizeDivs(e,t,a){t&&(t.style.top=e.style.top,t.style.left=parseInt(e.style.left)+parseInt(e.style.width)-5+"px",t.style.width="10px",t.style.height=e.style.height),a&&(a.style.top=parseInt(e.style.top)+parseInt(e.style.height)-5+"px",a.style.left=e.style.left,a.style.width=e.style.width,a.style.height="10px")}function renameIds(e){for(var t=0;t<e.childElementCount;t++)e.childNodes[t].id=divid+"-"+data.slides[0].id+"-"+t,e.childNodes[t].onmousedown=dispatchFocusEvent.bind(this,t)}function crossFade(e,t,a,i){var n,d;e.style.opacity=1,e.style.visibility="visible",e.style.display="block",t.style.opacity=1,t.style.visibility="visible",t.style.display="block",a&&(n=0,d=setInterval(function(){1<=(n+=25/a)&&(n=1),e.style.opacity=1-n,1==n&&(clearInterval(d),e.style.opacity=1,e.style.display="none",i&&i())},25))}function doVideo(){data=params.videoData,alt=data.scene.altCharacter,roles=alt?{main:!0,alt:!0}:{main:!0},cxSlide=data.scene.slideWidth,cySlide=data.scene.slideHeight,scenePreviewMode=!0;var s=[];params.videoSlide&&(s.push(data.slides[params.videoSlide-1]),params.videoSlide<data.slides.length&&s.push(data.slides[params.videoSlide])),data.slides=s,data.scene.navbar="",loadBackgroundResources(function(){loadCharacterBackgroundResources("main",function(){loadCharacterBackgroundResources("alt",function(){loadSlideBackgroundResources(function(){loadForegroundResources(function(){loadSlideResources(function(){if(setupScene(),updateHighlight(),document.getElementById(divid+"-top").style.visibility="visible",0<s.length){setupSlides(),updateSlideVisuals(!(stepShowing=slideShowing=1));var e=data.slides[0];if("bullet"==e.type)for(var t=document.getElementById(divid+"-slide-holder"),a=t.children[0].firstChild.querySelector(".title"),i=t.children[0].firstChild.querySelectorAll(".bullet"),n=1;n<=1+e.bullets.length;n++){a.style.visibility=1==n?"visible":"hidden";for(var d=0;d<i.length;d++)i[d].style.visibility=n-2==d?"visible":"hidden";window.callPhantom&&window.callPhantom({cmd:"snapshot",name:"step"+n})}else window.callPhantom&&window.callPhantom({cmd:"snapshot",name:"step1"});1<s.length&&(slideShowing=2,updateSlideVisuals(!(stepShowing=1)),window.callPhantom&&window.callPhantom({cmd:"snapshot",name:"next"})),slideShowing=void 0,updateSlideVisuals(!1)}data.scene.foregroundImage&&(setupForeground(),window.callPhantom&&window.callPhantom({cmd:"snapshot",name:"fore"}),document.getElementById(divid+"-foreground-div").style.visibility="hidden"),setupBackground(),setupClientScaleBackground("main"),alt&&setupClientScaleBackground("alt"),setupShadow("main"),alt&&setupShadow("alt"),setupSlideBackground(),setupSlideShadow(),window.callPhantom&&window.callPhantom({cmd:"snapshot",name:"back"}),window.callPhantom&&window.callPhantom({cmd:"end"})})})})})})})}function renderPromptArea(){var e='<div id="'+divid+'-prompt-holder" style="width:fit-content;" class="'+cssClass("promptBacker")+'"></div>',t=data.scene.promptAreaPosition||"bottom",a=data.scene.navbar?16:0,i="visibility:hidden;position:absolute;width:100%;";return"top"==t?i+="top:5px":"middle"==t?i+="top:50%;transform:translate(0,-50%)":"bottom"==t&&(i+="bottom:"+(5+a)+"px"),'<div id="'+divid+'-prompt-shelf" style="'+i+'"><div style="margin:auto;width:fit-content;">'+e+"</div></div>"}function liveAdjustPromptArea(){document.getElementById(divid+"-prompt-shelf").outerHTML=renderPromptArea()}function doPrompt(e){for(var t="",a=0;a<e.length;a++)t+='<button class="'+cssClass("promptButton")+'">'+(e[a].label||"")+"</button>";var i=document.getElementById(divid+"-prompt-holder"),n=(i.innerHTML=t,document.getElementById(divid+"-prompt-shelf"));if(n.style.visibility="visible",!scenePreviewMode)for(a=0;a<e.length;a++)e[a].event&&i.children[a].addEventListener("click",onPromptButtonClick.bind(null,e[a].event))}function onPromptButtonClick(e){removeAnyPrompt(),reactToEvent(e)}function removeAnyPrompt(){var e=document.getElementById(divid+"-prompt-holder"),e=(e&&(e.innerHTML=""),document.getElementById(divid+"-prompt-shelf"));e&&(e.style.visibility="hidden")}function renderChatArea(){var e,t="",a="popup"==data.scene.chatAreaBehavior,i=data.scene.chatAreaPosition||"bottomright",n=data.scene.chatAreaWidth||400,d=data.scene.chatAreaHeight||300,s=data.scene.navbar?16:0,d=d-110-(a?65:0)-s;return"bottomright"==i?e="right:0px; bottom:0px; margin: 0 5px "+(5+s)+"px 0;":"bottomleft"==i?e="left:0px; bottom:0px; margin: 0 0 "+(5+s)+"px 5px;":"topright"==i?e="right:0px; top:0px; margin: 5px 5px 0 0;":"topleft"==i&&(e="left:0px; top:0px; margin: 5px 0 0 5px;"),t+='<div id="'+divid+'-popup-container" style="position:absolute; width:'+n+"px; "+e+'">',data.scene.chatArea&&(a&&-1<i.indexOf("top")&&(t+=renderChatAreaLaunchButton(i)),t=(t=(t=(t=(t=t+'  <div id="'+divid+'-popup" style="display:none" class="rcw-conversation-container hidden" aria-live="polite">    <div class="rcw-header">')+'      <h4 class="rcw-title">'+(data.scene.chatAreaTitle||"")+"</h4>    </div>")+'    <div id="'+divid+'-popup-message-container" class="rcw-messages-container'+(scenePreviewMode?"-preview":"")+'" style="height:'+d+'px;">    </div>')+'    <form id="'+divid+'-form" class="rcw-sender" autoComplete="off">      <input id="'+divid+'-popup-input" type="text" maxlength="255" class="rcw-new-message" name="message" placeholder="'+(data.scene.chatAreaPlaceholder||"")+'"'+(params.scenePreview?" disabled":"")+">")+'      <button type="submit" class="rcw-send"><img src="'+mediaBase+'chatbot/send.svg" class="rcw-send-icon" alt="Send"></button>    </form>  </div>',a&&-1<i.indexOf("bottom")&&(t+=renderChatAreaLaunchButton(i))),t+="</div>"}function renderChatAreaLaunchButton(e){var t=-1<e.indexOf("right")?"right:0;":"left:0;",e=(-1<e.indexOf("bottom")?t+="margin-top:5px;":t+="margin-bottom:5px;","");return e+'<div style="width:100%; height:65px; position:relative">'+('  <button id="'+divid+'-popup-button" type="button" class="rcw-launcher" style="position:absolute; '+t+'">')+('    <img id="'+divid+'-popup-button-close" style="display:none;" src="'+mediaBase+'chatbot/clear.svg" class="rcw-close-launcher" alt="Close Chat" />')+('    <img id="'+divid+'-popup-button-open" src="'+mediaBase+'chatbot/launch.svg" class="rcw-open-launcher" alt="Open Chat" />')+"  </button>"+"</div>"}function setupChatArea(){"open"==data.scene.chatAreaBehavior&&openChatArea();var t=document.getElementById(divid+"-popup-button"),a=document.getElementById(divid+"-popup"),i=document.getElementById(divid+"-popup-button-open"),n=document.getElementById(divid+"-popup-button-close"),d=document.getElementById(divid+"-popup-container"),e=(t&&t.addEventListener("click",function(e){(a.classList.contains("hidden")?openChatArea:closeAnyChatArea)()}),document.getElementById(divid+"-popup-top-close")),s=(e&&e.addEventListener("click",function(e){a.classList.remove("active"),a.classList.add("hidden"),t.classList.remove("rcw-hide-sm"),i.style.display="",n.style.display="none",a.style.display="none",d.style.width="0"}),document.getElementById(divid+"-popup-input"));s.addEventListener("focusout",function(e){data.popup;s.setAttribute("placeholder",data.scene.chatAreaPlaceholder||"")}),s.addEventListener("focusin",function(e){s.setAttribute("placeholder","")}),document.getElementById(divid+"-form").addEventListener("submit",function(e){e.preventDefault();e=s.value.trim();s.value="",e&&(addMessage(e,!0),doReply(e))})}function isPopupOpen(){var e=document.getElementById(divid+"-popup");return e&&e.classList.contains("active")}function isPopupInMobileMode(){var e=window.matchMedia("screen and (max-width: 800px)");e&&e.matches}function showChatArea(){var e=document.getElementById(divid+"-popup-button"),t=document.getElementById(divid+"-popup"),a=document.getElementById(divid+"-popup-button-open"),i=document.getElementById(divid+"-popup-button-close");document.getElementById(divid+"-popup-container");t.classList.remove("hidden"),t.classList.add("active"),e&&e.classList.add("rcw-hide-sm"),a&&(a.style.display="none"),i&&(i.style.display=""),t.style.display=""}function openChatArea(){showChatArea(),document.getElementById(divid+"-popup-input").select()}function closeAnyChatArea(){var e,t,a,i;"open"!=data.scene.chatAreaBehavior&&(e=document.getElementById(divid+"-popup"),t=document.getElementById(divid+"-popup-button"),a=document.getElementById(divid+"-popup-button-open"),i=document.getElementById(divid+"-popup-button-close"),document.getElementById(divid+"-popup-container"),e&&(e.classList.remove("active"),e.classList.add("hidden"),e.style.display="none"),t&&(t.classList.remove("rcw-hide-sm"),a.style.display="",i.style.display="none"))}function liveAdjustChatArea(){document.getElementById(divid+"-popup-container").outerHTML=renderChatArea(),data.scene.chatArea&&showChatArea()}function addMessage(e,t){var a="",e=(a=(a=(a=(a+='<div class="rcw-message">')+('  <div class="rcw-'+(t?"client":"response")+'">')+'      <div class="rcw-message-text">')+("          "+e)+"      </div>")+"  </div>"+"</div>",document.getElementById(divid+"-popup-message-container")),a=(e.innerHTML=e.innerHTML+a,e.scrollTop=e.scrollHeight,document.getElementById(divid+"-popup"));!t&&a.classList.contains("hidden")&&(unseenMessages++,(e=document.getElementById(divid+"-popup-badge"))&&(e.innerHTML=unseenMessages,e.style.display="block"))}function handleChatResult(e){for(var t=scriptFromText(e.text),a=0;a<t.length;a++)dynamicPlay(t[a])}function handleReplyEvent(e){return"[continue]"==e&&(reactToEvent(e.substr(1,e.length-2)),1)}function showTranscript(){stagedTranscript&&(data.scene.chatArea&&addMessage(stagedTranscript,!1),document.getElementById(divid).dispatchEvent(createEvent("closedCaption",transcriptFromText(stagedTranscript))),stagedTranscript=void 0)}function setVariable(e,t){var a=variables[e];(variables[e]=t)!==a&&document.getElementById(divid).dispatchEvent(createEvent("variablesChanged")),storeVariables()}function storeVariables(){if("builder"==data.storage&&serverBase&&!scenePreviewMode&&!visualsPreviewMode)if(storing)storePending=!0;else{storing=!0;var t=new XMLHttpRequest,e=(t.open("POST",serverBase+"cb/setvariables",!0),t.onload=function(){storing=!1;var e=JSON.parse(t.response);if(!e.success)return console.log("People Builder service error storing variables: "+e.message);storePending&&(storePending=!1,storeVariables())},t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),"userid="+userid+"&moduleid="+moduleid+"&enduserid="+enduserid);for(a in variables)e+="&"+encodeURI(a)+"="+encodeURI(variables[a]);t.send(e)}if("builder"!=data.storage&&!scenePreviewMode&&!visualsPreviewMode)for(var a in variables)sessionStorage.setItem(moduleid+"-"+a,variables[a])}function loadVariables(a){if("builder"!=data.storage||!serverBase||scenePreviewMode||visualsPreviewMode){if("builder"!=data.storage)for(var e in sessionStorage)e.split("-")[0]==moduleid&&(variables[e.split("-")[1]]=sessionStorage[e]);a()}else{var i=new XMLHttpRequest;i.onload=function(){var e=null;try{var t=JSON.parse(i.response);if(!t.success)throw error();e=t.variables}catch(e){console.log("People Builder service error getting variables - treating as a first-time user")}e&&that.setVariables(e),a()},i.open("GET",serverBase+"cb/getvariables?userid="+userid+"&moduleid="+moduleid+"&enduserid="+enduserid,!0),i.send()}}this.disable=function(e){enableNavBarBtn(e,!1)},this.enable=function(e){enableNavBarBtn(e,!0)},this.highlightRegion=function(e){highlight=e,updateHighlight()},this.liveAdjust=function(e,t,a){var i=data.scene;if("alt"==e||"main"==e)"x"==t?i[e+"X"]=a:"y"==t?i[e+"Y"]=a:"backgroundType"==t?i[e+"BackgroundType"]=a:"backgroundSolid"==t?i[e+"BackgroundSolid"]=a:"backgroundGradient1"==t?i[e+"BackgroundGradient1"]=a:"backgroundGradient2"==t?i[e+"BackgroundGradient2"]=a:"backgroundImage"==t?i[e+"BackgroundImage"]=a:"shadow"==t?i[e+"Shadow"]=a:"width"==t?i[e+"Width"]=a:"height"==t?i[e+"Height"]=a:"xOffset"==t?i[e+"XOffset"]=a:"yOffset"==t?i[e+"YOffset"]=a:"scale"==t&&(i[e+"CharacterScale"]=a),liveAdjustCharacterPositionAndSize(e),liveAdjustCharacterScale(e),liveAdjustCharacterOffset(e),setupClientScaleBackground(e),setupShadow(e);else if("background"==e)"type"==t?i.backgroundType=a:"solid"==t?i.backgroundSolid=a:"gradient1"==t?i.backgroundGradient1=a:"gradient2"==t?i.backgroundGradient2=a:"image"==t&&(i.backgroundImage=a),setupBackground();else if("foreground"==e)"image"==t&&(i.foregroundImage=a),setupForeground();else if("module"==e){"width"==t?data.width=a:"height"==t&&(data.height=a);var n=document.getElementById(divid),n=(n.style.width=data.width+"px",n.style.height=data.height+"px",document.getElementById(divid+"-top")),n=(n.style.width=data.width+"px",n.style.height=data.height+"px",document.getElementById(divid+"-background-div"));n.style.width=data.width+"px",n.style.height=data.height+"px",setupBackground(),"explainer"!=moduletype&&"scenario"!=moduletype&&(setupSlideBackground(),setupSlideShadow()),liveAdjustNavBar()}else if("slide"==e){var n=document.getElementById(divid+"-slide-area"),d=document.getElementById(divid+"-slide-background-div");if("left"==t)n.style.left=a+"px",d.style.left=a+"px";else if("top"==t)n.style.top=a+"px",d.style.top=a+"px";else if("width"==t)n.style.width=a+"px",d.style.width=a+"px",cxSlide=data.scene.slideWidth=a,setupSlides();else if("height"==t)n.style.height=a+"px",d.style.height=a+"px",cySlide=data.scene.slideHeight=a,setupSlides();else if("backgroundType"==t)i[e+"BackgroundType"]=a;else if("backgroundSolid"==t)i[e+"BackgroundSolid"]=a;else if("backgroundGradient1"==t)i[e+"BackgroundGradient1"]=a;else if("backgroundGradient2"==t)i[e+"BackgroundGradient2"]=a;else if("backgroundImage"==t)i[e+"BackgroundImage"]=a;else if("shadow"==t)i.slideShadow=a;else if("contents"==t)return data.slides[slideShowing-1]=JSON.parse(JSON.stringify(a)),void loadSlideResources(function(){setupSlides()});setupSlideBackground(),setupSlideShadow(),updateSlideVisuals(!1)}else if("style"==e)data.style[t]=a,updateStylesheet(),setupSlides(),updateSlideVisuals(!1);else if("navbar"==e)"style"==t&&(data.scene.navbar=a),liveAdjustChatArea(),liveAdjustNavBar();else if("promptArea"==e)"position"==t&&(data.scene.promptAreaPosition=a),liveAdjustPromptArea();else if("chatArea"==e)"enabled"==t?data.scene.chatArea=a:"behavior"==t?data.scene.chatAreaBehavior=a:"position"==t?data.scene.chatAreaPosition=a:"width"==t?data.scene.chatAreaWidth=a:"height"==t?data.scene.chatAreaHeight=a:"title"==t?data.scene.chatAreaTitle=a:"placeholder"==t&&(data.scene.chatAreaPlaceholder=a),liveAdjustChatArea();else if("playShield"==e)"show"==t&&(data.scene.playShield=a,liveAdjustPlayShield());else if("video"==e)liveAdjustVideo(t,a);else if("step"==e){var s=data.slides[slideShowing-1];"workMode"==t?(workMode=a,updateAuthorFreeformSlideVisibility(s)):"stepPreview"==t&&(stepPreview=a,updateAuthorFreeformSlideVisibility(s))}else if("item-"==e.substr(0,5)){var o,r,n=parseInt(e.substr(5)),d=document.getElementById(divid+"-"+data.slides[0].id+"-"+n);if(!d)return;"x"==t?d.style.left=a+"px":"y"==t?d.style.top=a+"px":"width"==t?("text"==d.getAttribute("data-type")?void 0!==a?(d.style.width=a+"px",d.style.whiteSpace=""):(d.style.width="",d.style.whiteSpace="nowrap"):d.style.width=a+"px","iframe"==d.getAttribute("data-type")&&(d.firstChild.width=a)):"height"==t?(d.style.height=a+"px","iframe"==d.getAttribute("data-type")&&(d.firstChild.height=a)):"visible"==t?(i=(s=data.slides[slideShowing-1]).items[n],o=(e="step"==s.type.split("-")[1])?s.steps[stepPreview-1].id:"",!e||workMode?i.visible=a:(i.steps||(i.steps=[]),-1<(e=i.steps.indexOf(o))&&!a?i.steps.splice(e,1):-1==e&&a&&i.steps.push(o)),updateAuthorFreeformSlideVisibility(s)):"moveback"==t?(r=d.parentNode,e=d.previousSibling,r.removeChild(d),r.insertBefore(d,e),renameIds(r),highlight="item-"+(n-1)):"moveforward"==t?(r=d.parentNode,i=d.nextSibling.nextSibling,r.removeChild(d),i?r.insertBefore(d,i):r.appendChild(d),renameIds(r),highlight="item-"+(n+1)):"remove"==t?((r=d.parentNode).removeChild(d),renameIds(r),highlight=null):"text"==t?d.innerHTML=translateHTML(a):"label"==t?d.firstChild.innerHTML=a:"url"==t&&(d.firstChild.src=a)}updateHighlight()},this.getVariables=function(){return JSON.parse(JSON.stringify(variables))},this.setVariables=function(e){variables=e,document.getElementById(divid+"-slide-holder")&&bindSlides()};var animateBase=serverBase?serverBase+"cb/slideshowAnimate":null,dividOriginal=divid,enduserid,moduleRetract,moduleAssert,chatInputs=0,chatIdles=[],unseenMessages,replyData;function resetChatbotVars(){chatInputs=0}function getCookie(e){e=document.cookie.match("(^|;) ?"+e+"=([^;]*)(;|$)");return e?e[2]:null}function setCookie(e,t,a){var i=new Date;i.setTime(i.getTime()+864e5*a),document.cookie=e+"="+t+"; secure; path=/; samesite=none; partitioned; expires="+i.toGMTString()}function deleteCookie(e){document.cookie=e+"=; Max-Age=-99999999;"}function doReply(e){if(replying=!0,!serverBase)return console.log("People Builder - cannot run chatbot standalone.");"[idle"!=e.substr(0,5)&&resetIdleCount(Object.keys(roles)[0]);var t={text:e,retract:"",assert:""},a=(document.getElementById(dividOriginal).dispatchEvent(createEvent("preReply",t)),new XMLHttpRequest),i=(a.open("POST",serverBase+("edit"==params.version?"cb/previewReply":"cb/userReply"),!0),a.onload=function(){replying=!1;var e,t=JSON.parse(a.response);if(!t.success)return console.log("People Builder service error: "+t.message);replyData=t.data,handleReplyEvent(t.text)||(e={text:t.text},document.getElementById(dividOriginal).dispatchEvent(createEvent("postReply",e)),e.text&&handleChatResult(e)),chatIdles=t.idles},a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),"userid="+userid+"&moduleid="+moduleid+"&enduserid="+enduserid+"&input="+encodeURI(t.text)+(token?"&token="+token:"")),n=(replyData&&(i+="&data="+encodeURI(JSON.stringify(replyData))),""),n=(moduleRetract&&(n=moduleRetract,moduleRetract=null),t.retract&&(n+=(n?"^":"")+t.retract),n&&(i+="&retract="+encodeURI(n)),"");moduleAssert&&(n=moduleAssert,moduleAssert=null),t.assert&&(n+=(n?"^":"")+t.assert),n&&(i+="&assert="+encodeURI(n)),a.send(i),stopAll(),playQueue=[],"[autostart]"!=e&&"[idle"!=e.substr(0,5)&&"[nav]"!=e&&"popupbare"!=data.modulestyle&&dynamicPlay({do:"acknowledge"})}function scriptFromText(e){return sentenceSplit(e).map(function(e){var t={};if("["===e.substr(0,1)){var a=e.indexOf("]");if(-1===a)throw new Error("parse malformed tag");var i,n=e.substr(1,a-1);" "===(e=e.substr(a+1)).substr(0,1)&&(e=e.substr(1)),-1!==(a=n.indexOf(" and "))?(t.do=n.substr(0,a),-1!==(a=(i=n.substr(a+5,n.length-(a+5))).indexOf(" "))?(t.and=i.substr(0,a),a=i.substr(a+1).split(" "),"link"==t.and&&(t.url=a[0]||"",'""'==t.url&&(t.url=""),t.target=a[1]||"")):t.and=i):t.do=n}return"look-at-user"==t.do&&(t.do=""),e.substr(-1),e&&(t.say=e),t})}function sentenceSplit(e){for(var t=(e+" ").replace(/([\.!\?]+[ ]+)/g,"$1\n").split("\n"),a=[],i=0;i<t.length;i++){var n=t[i].trim();0<n.length&&a.push(n)}return a}function incrementIdleCount(e){void 0===idleCount[e]?(idleCount[e]=0)==idleCount[e]&&chatIdles&&-1<chatIdles.indexOf(0)&&doReply("[idle 0]"):(idleCount[e]++,chatIdles&&-1<chatIdles.indexOf(idleCount[e])&&doReply("[idle "+idleCount[e]+"]"))}function resetIdleCount(e){delete idleCount[e]}this.reply=function(e){doReply(e)};var audioContext=AudioContext?new AudioContext:null,externalGainNode=null,gainNode=null,audioBuffer,audioSource=(audioContext&&(externalGainNode=audioContext.createGain(),externalGainNode.gain.value=1,externalGainNode.connect(audioContext.destination),gainNode=audioContext.createGain(),gainNode.gain.value=1,gainNode.connect(externalGainNode)),{}),texture={},animData={},secondaryTextures={},defaultTexture={},lastExecute={},fpsInterval,now,then,elapsed,loaded={},loading={},idling={},animating={},frame={},starting={},stopping={},executeCallback={},deferredExecute={},rafid,atLeastOneLoadError,replying=!1,idleTimeout,timeSinceLastIdleCheck,timeSinceLastAction={},timeSinceLastBlink={},lastIdle="",idleCache={},idleCount={},timeSinceLastAudioStopped=0,settleTimeout={},delayTimeout={},preload=!0,preloaded=[],preloadQueue=[],preloading=null,preloadTimeout=null,preloadOnly=!1,preloadNextCallback,cacheBase=serverBase?"localhost"==window.location.hostname?"http://"+window.location.host+"/cbcache/":"https://cache.mediasemantics.com/":null,canvasTransformSrc={},canvasTransformDst={},sway={},swayTime={},swayTarget={},swayAccel={},breath={},breathTime={},random={},suppressRandom={},stagedTranscript;function resetInnerVars(){audioSource={},texture={},animData={},secondaryTextures={},defaultTexture={},lastExecute={},loaded={},loading={},animating={},idling={},frame={},stopping={},executeCallback={},deferredExecute={},timeSinceLastAction={},timeSinceLastBlink={},lastIdle="",settleTimeout={},delayTimeout={},preload=!(timeSinceLastAudioStopped=timeSinceLastIdleCheck=0),preloaded=[],preloadQueue=[],random={},suppressRandom={},stagedTranscript=preloadTimeout=preloading=idleTimeout=rafid=idleTimeout=audioBuffer=gainNode=null}function execute(e,t,a,i,n,d){var s;-1==t.indexOf("msg=")&&-1==t.indexOf("event=")&&-1==t.indexOf("dynamic=")||a||i||n?(apogee=!1,loading[e]||animating[e]?console.log("People Builder internal error"):(i&&stageTranscript(transcriptFromText(i)),t=t+"&role="+e,executeCallback[e]=d,stopping[e]=!1,loading[e]=!0,idling[e]=-1<t.indexOf("&idle="),animating[e]=!1,random[e]&&0<random[e].length&&!idling[e]&&(suppressRandom[e]=!0),s=getParamHash(e,a,i,n,!0),-1!=t.indexOf("dynamic=true")&&(a&&(t=t+"&do="+a),i&&(t=t+"&say="+encodeURIComponent(i)),n&&(t=t+"&audio="+encodeURIComponent(n))),lastExecute[e]==(a=t+"&hash="+s)?getItStarted(e,n||i):(lastExecute[e]=a,n&&"broken:"!=n.substr(0,7)?speakRecorded(e,t,n,s):containsActualSpeech(i)?speakTTS(e,t,s):loadAnimation(e,t,s,!1)))):(onEmbeddedCommand({type:"apogee"}),d&&d())}function containsActualSpeech(e){if(e)return(e=e.replace(/\[[^\]]*\]/g,""))&&!!e.match(/\S/)}function stageTranscript(e){stagedTranscript=e}function transcriptFromText(e){return e="string"==typeof e?(e=(e=(e=e.replace(/\[written\](.*?)\[\/written\]/g,"$1")).replace(/\[spoken\].*?\[\/spoken\]/g,"")).replace(/\[[^\[]*\]/g,function(e){return""})).trim().replace(/  /g," "):e}function getParamHash(e,t,a,i,n){var d=data.scene,s=data.externality||"1",s=(s+=d[e+"Character"])+d[e+"CharacterVersion"];return n&&(s+=d[e+"Voice"]),clientScale(e)||(s=(s=(s=(s=(s+=data.width)+data.height)+(d[e+"CharacterX"]||0))+(d[e+"CharacterY"]||0))+(d[e+"CharacterScale"]||100)),simpleHash(s=(s=(s=(s=(s=(s+=d[e+"CharacterDensity"]||1)+((t||"")+(a||"")+(i||""))+(d[e+"BackgroundType"]||""))+(d[e+"BackgroundSolid"]||""))+(d[e+"BackgroundGradient1"]||""))+(d[e+"BackgroundGradient2"]||""))+(d[e+"BackgroundImage"]||""))}function speakRecorded(t,a,e,i){var n,d,s;"stock:"==e.substr(0,6)?n=(mediaBase?mediaBase+"stock/audio/":"cb/"+moduleid+"/")+e.replace("stock:",""):"file:"==e.substr(0,5)&&(n=(mediaBase?mediaBase+userid+"/audio/":"cb/"+moduleid+"/")+e.replace("file:","")),audioContext?((d=new XMLHttpRequest).open("GET",n,!0),d.responseType="arraybuffer",d.onload=function(){audioContext.decodeAudioData(d.response,function(e){audioBuffer=e,loadAnimation(t,a,i,!0)})},d.onerror=function(){animateFailed(t)},d.send()):((s=document.getElementById(divid+"-audio")).oncanplaythrough=function(){s.pause(),loadAnimation(t,a,i,!0)},s.onerror=function(){animateFailed(t)},s.src=n),n&&-1==preloaded.indexOf(n)&&preloaded.push(n)}function speakTTS(t,a,i){var e,n,d,s="version="+version+a+"&hash="+i,o=hash[s];if(o=o||"edit"!=version?o:hash[s.replace("version=edit","version="+(data.version-1))])e=(cacheBase?cacheBase+userid:"cb")+"/"+moduleid+"/"+o.split(".")[0]+".mp3";else{if(!animateBase)return console.log("People Builder standalone error");e=animateBase+"?userid="+userid+"&module="+moduleid+"&version="+version+a+"&hash="+i+"&type=audio"+(token?"&token="+token:"")}audioContext?((n=new XMLHttpRequest).open("GET",e,!0),n.responseType="arraybuffer",n.onload=function(){audioContext.decodeAudioData(n.response,function(e){audioBuffer=e,loadAnimation(t,a,i,!0)},function(e){animateFailed(t)})},n.onerror=function(){animateFailed(t)},n.send()):((d=document.getElementById(divid+"-audio")).oncanplaythrough=function(){d.pause(),loadAnimation(t,a,i,!0)},d.onerror=function(){animateFailed(t)},d.src=e,d.play()),e&&-1==preloaded.indexOf(e)&&preloaded.push(e)}function loadAnimation(t,e,a,i){var n="version="+version+e+"&hash="+a;if(idleCache[n+"&type=data"]&&idleCache[n+"&type=image"])animData[t]=idleCache[n+"&type=data"],texture[t]=idleCache[n+"&type=image"],recordSecondaryTextures(t),loadSecondaryTextures(t,e,i);else{var d=hash[n];if(d=d||"edit"!=version?d:hash[n.replace("version=edit","version="+(data.version-1))])o=(s=(cacheBase?cacheBase+userid:"cb")+"/"+moduleid+"/"+d).replace(".png",".json").replace(".jpeg",".json");else{if(!animateBase)return console.log("People Builder standalone error");var d=animateBase+"?userid="+userid+"&module="+moduleid+"&version="+version+e+"&hash="+a,s=d+"&type=image"+(token?"&token="+token:""),o=d+"&type=data"+(token?"&token="+token:"")}var r=new XMLHttpRequest;r.open("GET",o,!0),r.onload=function(){try{animData[t]=JSON.parse(r.response)}catch(e){animateFailed(t)}texture[t]=new Image,texture[t].onload=function(){-1!=e.indexOf("&idle=")&&(idleCache[n+"&type=data"]=animData[t],idleCache[n+"&type=image"]=texture[t]),recordSecondaryTextures(t),loadSecondaryTextures(t,e,i)},texture[t].onerror=function(){animateFailed(t)},texture[t].crossOrigin="Anonymous",texture[t].src=s},r.onerror=function(){animateFailed(t)},r.send(),s&&-1==preloaded.indexOf(s)&&preloaded.push(s),o&&-1==preloaded.indexOf(o)&&preloaded.push(o)}}function recordSecondaryTextures(e){if(secondaryTextures[e]={},animData[e])for(var t=0;t<animData[e].textures.length;t++)"default"!=animData[e].textures[t]&&(secondaryTextures[e][animData[e].textures[t]]=null)}function loadSecondaryTextures(e,t,a){var i,n=!0;for(i in secondaryTextures[e])if(null==secondaryTextures[e][i]){n=!1;break}if(n)getItStarted(e,a);else{var d,s="&texture="+i+"&role="+e;if(idleCache[s+"&type=image"])secondaryTextures[e][i]=idleCache[s+"&type=image"],loadSecondaryTextures(e,t,a);else{var o=getParamHash(e,null,null,null,!1),r=hash["version="+version+s+"&hash="+o];if(r)d=(cacheBase?cacheBase+userid:"cb")+"/"+moduleid+"/"+r;else{if(!animateBase)return console.log("People Builder standalone error");d=animateBase+"?userid="+userid+"&module="+moduleid+"&version="+version+s+"&hash="+o+"&type=image"+(token?"&token="+token:"")}secondaryTextures[e][i]=new Image,secondaryTextures[e][i].crossOrigin="Anonymous",secondaryTextures[e][i].onload=function(){secondaryTextures[e]&&(-1==t.indexOf("&idle=")&&!isReusableTexture(i)||(idleCache[s+"&type=image"]=secondaryTextures[e][i]),loadSecondaryTextures(e,t,a))},secondaryTextures[e][i].onerror=function(){animateFailed(e)},(secondaryTextures[e][i].src=d)&&-1==preloaded.indexOf(d)&&preloaded.push(d)}}}function isReusableTexture(e){return e.match(/RandomRight|Jaw|Talk|Mouth|Eyes|Head\d+/)}function preloadExecute(e,t,a,i,n){var d,s=getParamHash(e,a,i,n,!0),o=(-1!=(t=t+"&role="+e).indexOf("dynamic=true")&&(a&&(t=t+"&do="+a),i&&(t=t+"&say="+encodeURIComponent(i)),n&&(t=t+"&audio="+encodeURIComponent(n))),"version="+version+t+"&hash="+s),r=hash[o];if(r||"edit"!=version||(r=hash[o.replace("version=edit","version="+(data.version-1))]),-1==t.indexOf("msg=")||a||i||n){if(n&&"broken:"!=n.substr(0,7))"stock:"==n.substr(0,6)?d=(mediaBase?mediaBase+"stock/audio/":"cb/"+moduleid+"/")+n.replace("stock:",""):"file:"==n.substr(0,5)&&(d=(mediaBase?mediaBase+userid+"/audio/":"cb/"+moduleid+"/")+n.replace("file:",""));else if(i)if(r)d=(cacheBase?cacheBase+userid:"cb")+"/"+moduleid+"/"+r.split(".")[0]+".mp3";else{if(!animateBase)return console.log("People Builder standalone error");d=animateBase+"?userid="+userid+"&module="+moduleid+"&version="+version+t+"&hash="+s+"&type=audio"+(token?"&token="+token:"")}if(d&&!preloadOnly&&preloadHelper(d),r)c=(l=(cacheBase?cacheBase+userid:"cb")+"/"+moduleid+"/"+r).replace(".png",".json").replace(".jpeg",".json"),c+="?role="+e;else{if(!animateBase)return console.log("People Builder standalone error");var o=animateBase+"?userid="+userid+"&module="+moduleid+"&version="+version+t+"&hash="+s+(preloadOnly?"&forcehash=true":"")+(token?"&token="+token:""),l=o+"&type=image",c=o+"&type=data"}l&&preloadHelper(l),c&&preloadHelper(c)}}function preloadHelper(e){-1==preloaded.indexOf(e)&&-1==preloadQueue.indexOf(e)&&preloadQueue.push(e)}function preloadSomeMore(){var o;preloadTimeout=null,preloading||0==preloadQueue.length||(preloading=preloadQueue.shift(),(o=new XMLHttpRequest).open("GET",preloading,!0),o.onload=function(){if(preloading){if(-1==preloaded.indexOf(preloading)&&preloaded.push(preloading),-1!=preloading.indexOf("&type=data")||-1!=preloading.indexOf(".json")){var t;try{t=JSON.parse(o.response)}catch(e){t=null}if(t)for(var e=0;e<t.textures.length;e++)if("default"!=t.textures[e]){var a,i=preloading.match(/role=([a-z]*)/)[1],n="&texture="+t.textures[e]+"&role="+i,i=getParamHash(i,null,null,null,!1),d=hash["version="+version+n+"&hash="+i];if(d)a=(cacheBase?cacheBase+userid:"cb")+"/"+moduleid+"/"+d;else{if(!animateBase)return console.log("People Builder standalone error");a=animateBase+"?userid="+userid+"&module="+moduleid+"&version="+version+n+"&hash="+i+"&type=image"+(preloadOnly?"&forcehash=true":"")+(token?"&token="+token:"")}preloadHelper(a)}}preloading=null}var s;preloadNextCallback?(s=preloadNextCallback,preloadNextCallback=null,s(preloadQueue.length)):0<preloadQueue.length&&(preloadTimeout=setTimeout(preloadSomeMore,500))},o.onerror=function(){preloading=null},o.send())}function getItStarted(e,t){var a;loading[e]=!1,showTranscript(),stopping[e]?animateComplete(e):(animating[e]=!0,starting[e]=!0,settleTimeout[e]&&(clearTimeout(settleTimeout[e]),settleTimeout[e]=0),(a=Date.now())-timeSinceLastAudioStopped<750?settleTimeout[e]=setTimeout(onSettleComplete.bind(null,e,t),750-(a-timeSinceLastAudioStopped)):getItStartedCheckDelay(e,t))}function onSettleComplete(e,t){settleTimeout[e]=0,getItStartedCheckDelay(e,t)}function getItStartedCheckDelay(e,t){delayTimeout[e]&&(clearTimeout(delayTimeout[e]),delayTimeout[e]=0),animData[e]&&(animData[e].leadingSilence&&t?(delayTimeout[e]=setTimeout(onDelayComplete.bind(null,e),animData[e].leadingSilence),getItStartedActual(e,!1)):getItStartedActual(e,t))}function onDelayComplete(e){getItStartedActual(e,!(delayTimeout[e]=0))}function getItStartedActual(e,t){if(rafid||(rafid=requestAnimationFrame(animate),fpsInterval=1e3/animData[e].fps,then=Date.now()),t)if(audioContext)try{audioSource[e]&&audioSource[e].stop(),audioSource[e]=audioContext.createBufferSource(),audioSource[e].buffer=audioBuffer,audioSource[e].connect(gainNode),gainNode.gain.value=1,audioSource[e].start()}catch(e){}else document.getElementById(divid+"-audio").play();starting[e]=!1,Math.random()<.5&&(swayTarget[e]=sway[e]),!preloadTimeout&&preload&&(preloadTimeout=setTimeout(preloadSomeMore,500))}function animate(){if(rafid=null,now=Date.now(),!((elapsed=now-then)<=fpsInterval)){then=now-elapsed%fpsInterval;var e,t=Math.max(1,Math.floor(elapsed/fpsInterval))-1,a={};for(e in roles)if(animData[e]){null==sway[e]&&(sway[e]=0),null==breath[e]&&(breath[e]=0),null==breathTime[e]&&(breathTime[e]=animData[e].breathCycle?animData[e].breathCycle/2+animData[e].breathCycle/2*Math.random():0);var i=!1,n=(random[e]||initRandomWalk(e,animData[e]),!!animData[e].swayLength&&!scenePreviewMode);if(n&&(updateSway(e,1+t),animData[e].breathCycle&&updateBreath(e),i=!0),animating[e]&&!starting[e])if(-1==frame[e])a[e]=!0;else{if(void 0===frame[e])frame[e]=0;else for(var d=frame[e]+1+t;frame[e]<d&&!(-1==animData[e].frames[frame[e]][1]||stopping[e]&&animData[e].frames[frame[e]][1]);)frame[e]++;i=!0}if(i&&document.getElementById(divid)&&"hidden"!=document.getElementById(divid).style.visibility){i=document.getElementById(divid+"-"+e+"-canvas");if(i){var s=n?(canvasTransformSrc[e+"G"]||(canvasTransformSrc[e+"G"]=document.createElement("canvas"),canvasTransformSrc[e+"G"].width=i.width,canvasTransformSrc[e+"G"].height=i.height+(animData[e].clothingOverhang||0)),canvasTransformSrc[e+"G"].getContext("2d",{willReadFrequently:!0})):i.getContext("2d"),o=animData[e].frames[frame[e]];if(animating[e]&&!starting[e]&&o){if(0<random[e].length&&controlRandomWalkSuppression(e,animData[e],frame[e]),s.clearRect(0,0,i.width,i.height),animData[e].recipes)for(var r=animData[e].recipes[o[0]],l=0;l<r.length;l++){var c,u=r[l][6],u="number"==typeof u?animData[e].textures[u]:"",u="default"==u&&defaultTexture[e]?defaultTexture[e]:secondaryTextures[e]&&secondaryTextures[e][u]?secondaryTextures[e][u]:texture[e],p="transparent"==data.scene[e+"BackgroundType"]||animData[e].layered||clientScale(e),h=r[l][7]||0;11<=h&&h<20&&updateRandomWalk(e,h),1==h||2==h?(c=updateTransform(u,r,l,e),s.drawImage(canvasTransformDst[e+h],0,0,r[l][4],r[l][5],r[l][0]+c.x,r[l][1]+c.y,r[l][4],r[l][5])):p?(animData[e].layered||3==h||s.clearRect(r[l][0],r[l][1],r[l][4],r[l][5]),s.drawImage(u,r[l][2],r[l][3]+(11<=h&&h<20?r[l][5]*random[e][h-10].frame:0),r[l][4],r[l][5],r[l][0],r[l][1]+(3==h&&animData[e].clothingOverhang||0),r[l][4],r[l][5])):s.drawImage(u,r[l][2]+0,r[l][3]+0,+r[l][4],+r[l][5],r[l][0]+0,r[l][1]+0,+r[l][4],+r[l][5])}else s.drawImage(texture[e],0,0,data.width,data.height,0,0,data.width,data.height);animData[e].frames[frame[e]][2]&&onEmbeddedCommand(animData[e].frames[frame[e]][2]);o=animData[e].frames[frame[e]][1];-1==o?frame[e]=-1:stopping[e]&&o&&(frame[e]=o)}n&&updateGlobalTransform(e,i)}}}for(e in a)animating[e]=!1,idling[e]=!1,stopping[e]=!1,frame[e]=void 0;for(e in a)animateComplete(e)}rafid=requestAnimationFrame(animate)}function initRandomWalk(e,t){random[e]=[];for(var a=1;a<=9;a++){var i=t["random"+a];i&&(random[e][a]={frame:0,inc:0,count:0,frames:parseInt(i.split(",")[0])})}}function controlRandomWalkSuppression(e,t,a){var i=!0;try{for(var n=0;n<6;n++){var d=a+n;if(-1==t.frames[d][1]||stopping&&t.frames[d][1])break;for(var s=t.frames[d],o=t.recipes[s[0]],r=!1,l=0;l<o.length;l++){var c=o[l][7]||0;if(11<=c&&c<20){r=!0;break}}if(!r){i=!1;break}}}catch(e){}suppressRandom[e]=!i}function updateRandomWalk(e,t){t=random[e][t-10];suppressRandom[e]?(1<t.frame&&(t.frame=Math.round(t.frame/2)),t.count=0,t.inc=0):0<t.count?(t.frame=Math.max(0,Math.min(t.frames-1,t.frame+t.inc)),t.count--):(t.count=Math.floor(t.frames/3)+Math.floor(Math.random()*t.frames),t.inc=Math.random()<.5?-1:1)}function updateTransform(F,e,t,a){var i=e[t][4],n=e[t][5],N=e[t][0],H=e[t][1],d=e[t][7],s=1==d?animData[a].mouthBendRadius:2==d||null!=animData[a].jawBendRadius?animData[a].jawBendRadius:0,o=1==d?animData[a].mouthTwistRadius:2==d||null!=animData[a].jawTwistRadius?animData[a].jawTwistRadius:0,r=-e[t][8]/180*Math.PI,j=e[t][9]/180*Math.PI,l=e[t][10]/180*Math.PI,c=(r+=(l+=j*animData[a].twistToSide)*(animData[a].sideToBend||0),animData[a].sideLength),q=animData[a].lowerJawDisplacement,G=e[t][8],u=e[t][11],V=e[t][12],p=[1,0,0,1,0,0],h=(l&&(addXForm(1,0,0,1,0,-c,p),addXForm(Math.cos(l),Math.sin(l),-Math.sin(l),Math.cos(l),0,0,p),addXForm(1,0,0,1,0,c,p)),(u||V)&&addXForm(1,0,0,1,u,V,p),canvasTransformSrc[a+d]||(canvasTransformSrc[a+d]=document.createElement("canvas"),canvasTransformSrc[a+d].width=i,canvasTransformSrc[a+d].height=n),canvasTransformSrc[a+d].getContext("2d",{willReadFrequently:!0}).clearRect(0,0,i,n),canvasTransformSrc[a+d].getContext("2d",{willReadFrequently:!0}).drawImage(F,e[t][2],e[t][3],i,n,0,0,i,n),canvasTransformSrc[a+d].getContext("2d",{willReadFrequently:!0}).getImageData(0,0,i,n)),m=(canvasTransformDst[a+d]||(canvasTransformDst[a+d]=document.createElement("canvas"),canvasTransformDst[a+d].width=i,canvasTransformDst[a+d].height=n),canvasTransformSrc[a+d].getContext("2d",{willReadFrequently:!0}).createImageData(i,n)),X=0,z=0;if(1==d||null!=animData[a].jawBendRadius)for(var X=Math.floor(N+o*Math.sin(j))-N,z=Math.floor(H-s*Math.sin(r))-H,g=i/2,v=n/2,l=Math.round(i/40)-1,c=i-5-l,u=i-l,W=(c-g)*(c-g)/(g*g),y=(u-g)*(u-g)/(g*g),f=0,S=0;S<n;S++)for(var w=0;w<i;w++){var Q=S+.001-n/2+z,b=o*Math.sin(Math.asin((w+.001-i/2+X)/o)-j),Q=s*Math.sin(Math.asin(Q/s)+r);x=p[0]*b+p[2]*Q+p[4]+i/2,I=p[1]*b+p[3]*Q+p[5]+n/2,(B=Math.max(Math.min(Math.floor(x),i-1),0))==(k=Math.max(Math.min(Math.ceil(x),i-1),0))&&(0==B?k++:B--),(M=Math.max(Math.min(Math.floor(I),n-1),0))==(C=Math.max(Math.min(Math.ceil(I),n-1),0))&&(0==M?C++:M--),E=4*M*i+4*B,P=4*M*i+4*k,T=4*C*i+4*B,A=4*C*i+4*k,D=Math.round((k-x)*(C-I)*h.data[E+0]+(x-B)*(C-I)*h.data[P+0]+(k-x)*(I-M)*h.data[T+0]+(x-B)*(I-M)*h.data[A+0]),L=Math.round((k-x)*(C-I)*h.data[E+1]+(x-B)*(C-I)*h.data[P+1]+(k-x)*(I-M)*h.data[T+1]+(x-B)*(I-M)*h.data[A+1]),R=Math.round((k-x)*(C-I)*h.data[E+2]+(x-B)*(C-I)*h.data[P+2]+(k-x)*(I-M)*h.data[T+2]+(x-B)*(I-M)*h.data[A+2]),1==d?O=y<(b=(w-g)*(w-g)/(g*g)+(S-v)*(S-v)/(v*v))?0:W<=b&&b<=y?Math.round((Math.sqrt(y)-Math.sqrt(b))/(Math.sqrt(y)-Math.sqrt(W))*255):255:2==d?(O=Math.round((k-x)*(C-I)*h.data[E+3]+(x-B)*(C-I)*h.data[P+3]+(k-x)*(I-M)*h.data[T+3]+(x-B)*(I-M)*h.data[A+3]),S<n/10&&(O=Math.min(O,S/(n/10)*255))):O=255,m.data[f]=D,f++,m.data[f]=L,f++,m.data[f]=R,f++,m.data[f]=O,f++}else if(2==d)for(var x,I,B,k,M,C,E,P,T,A,D,L,R,f=0,S=0;S<n;S++)for(var O,w=0;w<i;w++)x=w,I=S-G*q*S/n,(B=Math.max(Math.min(Math.floor(x),i-1),0))==(k=Math.max(Math.min(Math.ceil(x),i-1),0))&&(0==B?k++:B--),(M=Math.max(Math.min(Math.floor(I),n-1),0))==(C=Math.max(Math.min(Math.ceil(I),n-1),0))&&(0==M?C++:M--),E=4*M*i+4*B,P=4*M*i+4*k,T=4*C*i+4*B,A=4*C*i+4*k,D=Math.round((k-x)*(C-I)*h.data[E+0]+(x-B)*(C-I)*h.data[P+0]+(k-x)*(I-M)*h.data[T+0]+(x-B)*(I-M)*h.data[A+0]),L=Math.round((k-x)*(C-I)*h.data[E+1]+(x-B)*(C-I)*h.data[P+1]+(k-x)*(I-M)*h.data[T+1]+(x-B)*(I-M)*h.data[A+1]),R=Math.round((k-x)*(C-I)*h.data[E+2]+(x-B)*(C-I)*h.data[P+2]+(k-x)*(I-M)*h.data[T+2]+(x-B)*(I-M)*h.data[A+2]),O=Math.round((k-x)*(C-I)*h.data[E+3]+(x-B)*(C-I)*h.data[P+3]+(k-x)*(I-M)*h.data[T+3]+(x-B)*(I-M)*h.data[A+3]),S<n/10&&(O=Math.min(O,S/(n/10)*255)),m.data[f]=D,f++,m.data[f]=L,f++,m.data[f]=R,f++,m.data[f]=O,f++;return canvasTransformDst[a+d].getContext("2d").putImageData(m,0,0),{x:X,y:z}}function updateGlobalTransform(e,t){for(var a,i,n,d,s,o,r,l,c,u,p=t.width,h=t.height,m=animData[e].swayLength,g=animData[e].swayBorder,v=animData[e].swayProcess||1,y=[1,0,0,1,0,0],f=[1,0,0,1,0,0],S=[1,0,0,1,0,0],w=(1==v?(addXForm(1,0,0,1,0,-m,y),addXForm(Math.cos(sway[e]),Math.sin(sway[e]),-Math.sin(sway[e]),Math.cos(sway[e]),0,0,y),addXForm(1,0,0,1,0,m,y)):2==v&&(addXForm(1,0,0,1,0,-h/2,S),addXForm(Math.cos(-sway[e]),Math.sin(-sway[e]),-Math.sin(-sway[e]),Math.cos(-sway[e]),0,0,S),addXForm(1,0,0,1,0,h/2,S),a=h/2*Math.tan(sway[e]),addXForm(1,0,0,1,0,0,f),addXForm(Math.cos(sway[e]/2),Math.sin(sway[e]/2),-Math.sin(sway[e]/2),Math.cos(sway[e]/2),0,0,f),addXForm(1,0,0,1,0,0,f)),animData[e].clothingOverhang||0),b=canvasTransformSrc[e+"G"].getContext("2d",{willReadFrequently:!0}).getImageData(0,0,p,h+w),x=t.getContext("2d",{willReadFrequently:!0}).createImageData(p,h),I=0,B=[],k=0;k<p;k++)B[k]=breath[e]*(Math.cos(2*k*Math.PI/p)/2+.5);for(var M=0;M<h;M++)for(var C,E,P,T,A,D,k=0;k<p;k++)g&&(k<g||p-g<k)?(x.data[I]=0,I++,x.data[I]=0,I++,x.data[I]=0,I++,x.data[I]=0,I++):(A=k+.001-p/2,D=M+.001-h/2,1==v?(E=y[0]*A+y[2]*D+y[4],P=y[1]*A+y[3]*D+y[5]):2==v&&(P=M<h/2-(C=h/10)?(E=f[0]*A-a+f[2]*D+f[4],f[1]*A+f[3]*D+f[5]):M<h/2+C?(E=(f[0]*A-a+f[2]*D+f[4])*(1-(C=(M-(h/2-C))/(2*C)))+(S[0]*A+S[2]*D+S[4])*C,(f[1]*A+f[3]*D+f[5])*(1-C)+(S[1]*A+S[3]*D+S[5])*C):(E=S[0]*A+S[2]*D+S[4],S[1]*A+S[3]*D+S[5])),C=E+p/2,A=P+h/2,A-=B[k],(D=Math.max(Math.min(Math.floor(C),p-1),0))==(i=Math.max(Math.min(Math.ceil(C),p-1),0))&&(0==D?i++:D--),(n=Math.max(Math.min(Math.floor(A),h+w-1),0))==(d=Math.max(Math.min(Math.ceil(A),h+w-1),0))&&(0==n?d++:n--),T=4*n*p+4*D,s=4*n*p+4*i,o=4*d*p+4*D,r=4*d*p+4*i,l=Math.round((i-C)*(d-A)*b.data[T]+(C-D)*(d-A)*b.data[s]+(i-C)*(A-n)*b.data[o]+(C-D)*(A-n)*b.data[r]),c=Math.round((i-C)*(d-A)*b.data[1+T]+(C-D)*(d-A)*b.data[1+s]+(i-C)*(A-n)*b.data[1+o]+(C-D)*(A-n)*b.data[1+r]),u=Math.round((i-C)*(d-A)*b.data[2+T]+(C-D)*(d-A)*b.data[2+s]+(i-C)*(A-n)*b.data[2+o]+(C-D)*(A-n)*b.data[2+r]),T=Math.round((i-C)*(d-A)*b.data[3+T]+(C-D)*(d-A)*b.data[3+s]+(i-C)*(A-n)*b.data[3+o]+(C-D)*(A-n)*b.data[3+r]),x.data[I]=l,I++,x.data[I]=c,I++,x.data[I]=u,I++,x.data[I]=T,I++);t.getContext("2d").putImageData(x,0,0)}function addXForm(e,t,a,i,n,d,s){s[0]=e*s[0]+a*s[1],s[2]=e*s[2]+a*s[3],s[4]=e*s[4]+a*s[5]+n,s[1]=t*s[0]+i*s[1],s[3]=t*s[2]+i*s[3],s[5]=t*s[4]+i*s[5]+d}function stopAll(){var e,t;for(t in audioContext?(gainNode&&gainNode.gain.setTargetAtTime(0,audioContext.currentTime,.015),timeSinceLastAudioStopped=Date.now()):(e=document.getElementById(divid+"-audio"))&&e.pause(),roles)(loading[t]||animating[t])&&(stopping[t]=!0),deferredExecute[t]&&(deferredExecute[t]=null,onScriptLineDone()),delayTimeout[t]&&(clearTimeout(delayTimeout[t]),delayTimeout[t]=0,animateComplete(t)),settleTimeout[t]&&(clearTimeout(settleTimeout[t]),settleTimeout[t]=0,animating[t]=!1,idling[t]=!1,animateComplete(t))}function animateFailed(e){console.log("People Builder service error"),atLeastOneLoadError=!0,loading[e]=!1,animateComplete(e)}function animateComplete(e){var t;timeSinceLastAction[e]=0,loaded[e]?(audioSource[e]&&(audioSource[e].stop(),audioSource[e]=null,timeSinceLastAudioStopped=Date.now()),executeCallback[e]&&(t=executeCallback[e],executeCallback[e]=null,t&&t())):(loaded[e]=!0,!defaultTexture[e]&&texture[e]&&animData[e]&&animData[e].recipes&&(defaultTexture[e]=texture[e]),timeSinceLastBlink[e]=0,characterLoaded(e))}function isVector(e){return void 0!==data.scene[e+"CharacterType"]?"vector"==data.scene[e+"CharacterType"]:"illustrated"==(e=data.scene[e+"CharacterStyle"]||"").split("-")[0]||"cs"==e||"classic"==e}function clientScale(e){return scenePreviewMode||!isVector(e)&&(data.scene[e+"CharacterScale"]||100)!=100*(data.scene[e+"CharacterDensity"]||1)||data.scene[e+"CharacterRequiresPng"]}function getIdles(e){var t=data.scene[e+"CharacterIdleData"];if(t){for(var a=[],i=0;i<t[idleType].length;i++){var n=t[idleType][i],d=n.match(/([a-z]+)([0-9]+)-([0-9]+)/);if(d)for(i=parseInt(d[2]);i<=parseInt(d[3]);i++)a.push(d[1]+i);else a.push(n)}return a}return console.log("missing idleData"),[]}function startIdle(){idleTimeout=idleTimeout||setTimeout(checkIdle,1e3)}function checkIdle(){var e,t=Date.now(),a=t-(timeSinceLastIdleCheck||t);for(e in timeSinceLastIdleCheck=t,roles)timeSinceLastAction[e]+=a,timeSinceLastBlink[e]+=a;for(e in roles)scenePreviewMode||!loaded[e]||loading[e]&&!idling[e]||animating[e]&&!idling[e]||atLeastOneLoadError||replying||incrementIdleCount(e);for(e in roles)if(!scenePreviewMode&&loaded[e]&&!loading[e]&&!animating[e]&&!atLeastOneLoadError&&!replying&&timeSinceLastAction[e]>1500+3500*Math.random()){timeSinceLastAction[e]=0;var i=getIdles(e),n=null,d=0<i.length&&"blink"==i[0];if(d&&timeSinceLastBlink>5e3+5e3*Math.random())timeSinceLastBlink=0,n="blink";else{if(d&&i.shift(),0<i.length)if(lastIdle)for(var s=10;0<s&&(n=i[Math.floor(Math.random()*i.length)])==lastIdle;s--);else n=i[0];n&&(lastIdle=n)}if(n){execute(e,"&idle="+n,n,null,null,onIdleComplete.bind(null,e));break}}idleTimeout=setTimeout(checkIdle,1e3)}function simpleHash(e){var t=0;if(0==e.length)return t;for(var a=0;a<e.length;a++){t=(t<<5)-t+e.charCodeAt(a);t&=t}return(t=Math.abs(t)).toString()}function fadeIn(e,t,a){var i,n;e.style.opacity=0,e.style.visibility="visible",t?(i=0,n=setInterval(function(){1<=(i+=50/t)&&(clearInterval(n),i=1,a&&a()),e.style.opacity=i},50)):(e.style.opacity=1,a&&a())}function fadeOut(e,t,a){var i,n;t?(i=1,n=setInterval(function(){(i-=50/t)<=0&&(clearInterval(n),i=1,e.style.visibility="hidden",a&&a()),e.style.opacity=i},50)):(e.style.opacity=1,e.style.visibility="hidden",a&&a())}function setupPlayShield(e,t){var a,i=document.getElementById(divid+"-playshield-canvas");i&&((a=i.getContext("2d")).fillStyle="#000000",a.globalAlpha=.5,a.fillRect(0,0,e,t),e=e/2,t=t/2,a.beginPath(),a.arc(e,t,25,0,2*Math.PI,!1),a.fillStyle="#999999",a.globalAlpha=.5,a.fill(),a.beginPath(),a.arc(e,t,27,0,2*Math.PI,!1),a.strokeStyle="#cccccc",a.lineWidth=5,a.globalAlpha=1,a.stroke(),a.beginPath(),a.moveTo(e-=12,t-=15),a.lineTo(e,t+=30),a.lineTo(e+=30,t-=15),a.lineTo(e-=30,t-=15),a.fillStyle="#cccccc",a.globalAlpha=1,a.fill(),i.onclick=onPlayShieldClick)}function createEvent(e,t){var a;return"function"==typeof Event?new CustomEvent(e,{detail:t}):((a=document.createEvent("Event")).initCustomEvent(e,!1,!1,t),a)}function updateSway(e,t){for((null==swayTarget[e]||Math.abs(sway[e]-swayTarget[e])<.001)&&(that.playing?(swayTarget[e]=-animData[e].normalSwayRange+Math.random()*animData[e].normalSwayRange*2,swayAccel[e]=animData[e].normalSwayAccelMin+(animData[e].normalSwayAccelMax-animData[e].normalSwayAccelMin)*Math.random()):(swayTarget[e]=-animData[e].idleSwayRange+Math.random()*animData[e].idleSwayRange*2,swayAccel[e]=animData[e].idleSwayAccelMin+(animData[e].idleSwayAccelMax-animData[e].idleSwayAccelMin)*Math.random()));0<t;)sway[e]+=(swayTarget[e]-sway[e])*swayAccel[e],t--}function updateBreath(e){breath[e]=(animData[e].shoulderDisplacement||0)*Math.max(0,Math.sin(2*breathTime[e]*Math.PI/animData[e].breathCycle)),breathTime[e]+=fpsInterval}this.cleanup=function(){stopAll(),idleTimeout&&clearTimeout(idleTimeout),preloadTimeout&&clearTimeout(preloadTimeout),rafid&&cancelAnimationFrame(rafid),rafid=null;var e=document.getElementById(divid);e&&(e.innerHTML=""),resetInnerVars(),resetOuterVars()}}